<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>PE文件结构 | iyheart的博客</title><meta name="author" content="iyheart"><meta name="copyright" content="iyheart"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言：大三有逆向课，现在也学点吧">
<meta property="og:type" content="article">
<meta property="og:title" content="PE文件结构">
<meta property="og:url" content="http://iyheart.github.io/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/index.html">
<meta property="og:site_name" content="iyheart的博客">
<meta property="og:description" content="前言：大三有逆向课，现在也学点吧">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/cover201.png">
<meta property="article:published_time" content="2025-08-08T04:10:50.000Z">
<meta property="article:modified_time" content="2025-08-10T15:38:16.472Z">
<meta property="article:author" content="iyheart">
<meta property="article:tag" content="博客, 笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/cover201.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://iyheart.github.io/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PE文件结构',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-10 23:38:16'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/styles.css"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="iyheart的博客" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="http://pic.5tu.cn/uploads/allimg/1910/pic_5tu_big_2019010211653346247.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">163</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">49</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 历史</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-music"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-tasks"></i><span> 知识库</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/docs/"><i class="fa-fw fas fa-book"></i><span> 编程语言知识库</span></a></li><li><a class="site-page child" href="/practice/"><i class="fa-fw fas fa-book"></i><span> PWN刷题记录</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-bell"></i><span> 更新</span></a></div><div class="menus_item"><a class="site-page" href="javascript:toRandomPost()"><i class="fa-fw fas fa-bus"></i><span> 随机文章</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontent.com/iyheart/tuchuang/main/img/cover201.png')"><nav id="nav"><span id="blog-info"><a href="/" title="iyheart的博客"><img class="site-icon" src="http://img95.699pic.com/photo/40151/9175.gif_wh860.gif"/><span class="site-name">iyheart的博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 历史</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-music"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-tasks"></i><span> 知识库</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/docs/"><i class="fa-fw fas fa-book"></i><span> 编程语言知识库</span></a></li><li><a class="site-page child" href="/practice/"><i class="fa-fw fas fa-book"></i><span> PWN刷题记录</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-bell"></i><span> 更新</span></a></div><div class="menus_item"><a class="site-page" href="javascript:toRandomPost()"><i class="fa-fw fas fa-bus"></i><span> 随机文章</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PE文件结构</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-08-08T04:10:50.000Z" title="发表于 2025-08-08 12:10:50">2025-08-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-10T15:38:16.472Z" title="更新于 2025-08-10 23:38:16">2025-08-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/">CTF</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/REVERSE/">REVERSE</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>22分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PE文件结构"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><ul>
<li>推荐查看<code>PE</code>文件格式的工具：<code>010editor</code>、<code>CFF</code>、<code>winhex</code>。</li>
<li>其中<code>010editor</code>可以在之后逆向作为工具使用（其有PE模版，PE不同头的部分会有不同颜色的高亮），CFF可以具体查看PE文件结构体的具体值，<code>winhex</code>二进制查看器（用于学习）。</li>
<li>CFF汉化版：[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-138015.htm">分享][汉化]CFF Explorer 7.9 官方版（支持中文）-安全工具-看雪-安全社区|安全招聘|kanxue.com</a></li>
</ul>
<h1 id="vs2022写汇编">VS2022写汇编</h1>
<ul>
<li>由于要用到<code>vs2022</code>编写汇编程序所以先来简单介绍一下在<code>vs2022</code>中如何可以设置编译汇编。先新建一个项目</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701181212392.png" alt="image-20250701181212392"></p>
<ul>
<li>然后选择新建这个类型的项目</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701181246713.png" alt="image-20250701181246713"></p>
<ul>
<li>点击<code>Windows</code>桌面引导后就选择如图选项</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701181352226.png" alt="image-20250701181352226"></p>
<ul>
<li>之后右键新创建的项目，选择<code>生成依赖项---&gt;生成自定义</code></li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701181501755.png" alt="image-20250701181501755"></p>
<ul>
<li>勾选<code>masm</code>选项</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701181525445.png" alt="image-20250701181525445"></p>
<ul>
<li>现在就可以新建一个<code>.asm</code>后缀的文件，写入如下代码，注意下面这个汇编代码是在<code>i386</code>架构下的</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701181557776.png" alt="image-20250701181557776"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.386</span><br><span class="line">.model flat, stdcall</span><br><span class="line">option casemap:none</span><br><span class="line"></span><br><span class="line">extern MessageBoxA@16:proc</span><br><span class="line">extern ExitProcess@4:proc</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">    msgTitle db &quot;PE&quot;, 0</span><br><span class="line">    msgText  db &quot;Hello world!&quot;, 0</span><br><span class="line"></span><br><span class="line">.code</span><br><span class="line">main:</span><br><span class="line">    push 0</span><br><span class="line">    push offset msgTitle</span><br><span class="line">    push offset msgText</span><br><span class="line">    push 0</span><br><span class="line">    call MessageBoxA@16</span><br><span class="line"></span><br><span class="line">    push 0</span><br><span class="line">    call ExitProcess@4</span><br><span class="line">    ret</span><br><span class="line">end main</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>既然是<code>i386</code>架构下的汇编，我们就需要将这里设置为<code>x86</code>，建议<code>debug</code>模式</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701181815141.png" alt="image-20250701181815141"></p>
<ul>
<li>之后查看编译器是<code>ml.exe</code>还是<code>ml64.exe</code>，因为<code>x86</code>和<code>x64</code>的汇编语法上会存在不同，使用<code>ml64</code>编译<code>i386</code>的程序会编译不通过。</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701181930556.png" alt="image-20250701181930556"></p>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701182019631.png" alt="image-20250701182019631"></p>
<ul>
<li>如果是<code>release</code>模式，在编译的时候就会出现这个问题</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701182127025.png" alt="image-20250701182127025"></p>
<ul>
<li>这个也比较好解决，解决方法就是在下图的<code>命令行</code>这一栏添加这么一句<code>ml</code>的汇编命令<code>/SAFESEH:NO</code></li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701182250518.png" alt="image-20250701182250518"></p>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701182319450.png" alt="image-20250701182319450"></p>
<ul>
<li>这样就可以编译通过了</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701182409366.png" alt="image-20250701182409366"></p>
<h1 id="pe文件结构简述">PE文件结构简述</h1>
<ul>
<li>每个成熟的带有后缀名的文件比如<code>.exe</code>、<code>.pdf</code>、<code>.jpg</code>等文件都会有属于自己特有的文件头和文件尾。当我们查看或者运行这些文件的时候，操作系统并不是根据后缀名来识别这些文件类型。操作系统是通过识别这些<strong>文件的文件头和文件尾</strong>来判断这些文件具体是属于哪一类型。</li>
<li><code>PE</code>，英文全称为<code>portable executable</code>是可移植可执行文件。</li>
<li>对于<code>PE</code>可执行文件即<code>.exe</code>后缀的文件也是如此，<code>PE</code>文件也有属于自己的文件结果（文件头和文件尾），在这些文件中隐藏着一些程序运行的信息，并且<strong>一些反调试技术也与PE文件格式相关</strong>，所以在学<code>Windows</code>用户程序逆向之前，先要具体详细地学习一下<code>PE</code>文件结构。</li>
<li><code>PE</code>文件头大概有如下结构：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">IMAGE_DOS_HEADER;  			<span class="comment">//DOS头</span></span><br><span class="line">IMAGE_NT_HEADERS;  			<span class="comment">//NT头,NT头包含了两个子结构</span></span><br><span class="line">    IMAGE_FILE_HEADER;  	<span class="comment">//NT的文件头</span></span><br><span class="line">	IMAGE_OPTIONAL_HEADER;	<span class="comment">//NT的选项头文件,为可执行文件指定选项</span></span><br><span class="line">IMAGE_SECTION_HEADER;		<span class="comment">//段头,段头与段数据的风格就是类似于Pascal风格字符串.有几个段数据,就会出现段头,</span></span><br><span class="line">.....						<span class="comment">//段头都被放在一起</span></span><br><span class="line">IMAGE_SECTION_HEADER;		<span class="comment">//段头</span></span><br><span class="line">SECTION_DATA;				<span class="comment">//段数据</span></span><br><span class="line">....</span><br><span class="line">SECTION_DATA;				<span class="comment">//段数据</span></span><br><span class="line">user data;					<span class="comment">//附加数据,属于自定义类型,不属于格式一类.</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>PE</code>文件处于内存中的时候通常称为<strong>映像</strong></li>
</ul>
<h1 id="pe文件结构">PE文件结构</h1>
<ul>
<li>上面我们已经使用<code>VS2022</code>汇编出了<code>exe</code>文件，先使用<code>010Editor</code>查看一下这个<code>exe</code>文件<code>PE</code>结构。</li>
</ul>
<h2 id="dos头">DOS头</h2>
<ul>
<li><code>MZ</code>是一个DOS头的识别部分，当操作系统执行这个可执行文件的时候，并不是看拓展名，而是看这个文件的二进制形式，其实<code>DOS</code>头的<strong>标志性标识</strong>其实就是<code>0x4D 0x5A</code>也就是<code>MZ</code>，<code>MZ</code>其实是<code>DOS</code>最早期作者的名字缩写。</li>
<li>而这个<code>DOS头</code>中我们标注<code>CC</code>的这边实际上是<strong>可以任意修改的、可以使用的</strong>，修改后并不影响其执行。标注<code>CC</code>的地方其实是为<code>DOS</code>文件执行的时候提供环境信息，这个环境信息包括<strong>寄存器值、可选重定位表、中断向量表、文件句柄表等</strong></li>
<li>最后的<code>32</code>位其实标明了<strong>新结构的位置(NT头的位置)</strong>，其中<code>0xC8</code>其实就是<code>PE</code>结构标识符中<code>P</code>字母的位置。</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701190415703.png" alt="image-20250701190415703"></p>
<ul>
<li>在<code>PE</code>和<code>DOS</code>头这边还有一段数据，其实也就是这一段数据。这一部分被称为<code>Stub</code>数据，通常被叫做<strong>残留数据</strong>(包含二进制指令和数据)。</li>
<li>当该文件在DOS下执行时，其就会真正从<code>offset=0x40</code>这个位置开始执行，最先开始执行<code>0x0E</code></li>
<li>在<code>DOS</code>执行后就会出现这样的提示：<code>This program cannot be run in DOS mode.</code></li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701190659291.png" alt="image-20250701190659291"></p>
<ul>
<li>使用<code>IDA</code>反汇编就能看到这一段的具体指令了</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701191610768.png" alt="image-20250701191610768"></p>
<ul>
<li>接下来为了更熟悉<code>DOS</code>文件结构，就将<code>DOS</code>结构体敲一遍抄下来</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> stuct _IMAGE_DOS_HEADER&#123;</span><br><span class="line">    WORD e_magic;		<span class="comment">//0x00 魔数: 存储DOS头&quot;MZ&quot;(0x5A4D,小端序就变成0x4D5A)</span></span><br><span class="line">    WORD e_cblp;		<span class="comment">//0x02 存储最后一页剩余的字节数</span></span><br><span class="line">    WORD e_cp;			<span class="comment">//0x04 文件总页数(512字节为单位)</span></span><br><span class="line">    WORD e_crlc;		<span class="comment">//0x06 重定位表项数</span></span><br><span class="line">    WORD e_cparhdr;		<span class="comment">//0x08 头部大小(以16字节为单位)</span></span><br><span class="line">    WORD e_minalloc;	<span class="comment">//0x0A 程序最小额外分配内存(段数)</span></span><br><span class="line">    WORD e_maxalloc;	<span class="comment">//0x0C 程序最大额外分配内存(段数)</span></span><br><span class="line">    WORD e_ss;			<span class="comment">//0x0E 初始栈段地址(相对加载地址)</span></span><br><span class="line">    WORD e_sp;			<span class="comment">//0x10 初始栈指针</span></span><br><span class="line">    WORD e_csum;		<span class="comment">//0x12 校验和(通常为0,未使用)</span></span><br><span class="line">    WORD e_ip;			<span class="comment">//0x14 初始指令指针(寄存器IP的初始值)</span></span><br><span class="line">    WORD e_csl;			<span class="comment">//0x16 初始代码段地址 (相对加载地址)</span></span><br><span class="line">    WORD e_lfarlc;		<span class="comment">//0x18 重定位表偏移 (从文件头开始的偏移)</span></span><br><span class="line">    WORD e_ovno;		<span class="comment">//0x1A overlay号 (从文件头开始的偏移)(用于老式 DOS 多阶段加载)</span></span><br><span class="line">    WORD e_res[<span class="number">4</span>];		<span class="comment">//0x1C~0x24 保留字段</span></span><br><span class="line">    WORD e_oemid;		<span class="comment">//0x24 OEM标识符(用户自定义)(系统厂商自定义)</span></span><br><span class="line">    WORD e_oemindfo;	<span class="comment">//0x26 OEM信息(和e_oemid配对)</span></span><br><span class="line">    WORD e_res2[<span class="number">10</span>];	<span class="comment">//0x28~0x3C 额外保留字段</span></span><br><span class="line">    LONG e_lfanew;		<span class="comment">//0x3C 指向 PE 文件头 (NT头) 偏移</span></span><br><span class="line">&#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br></pre></td></tr></table></figure>
<ul>
<li>其实这一段都是可以<code>人为修改</code>和<code>利用</code>的</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701193847234.png" alt="image-20250701193847234"></p>
<h2 id="nt头">NT头</h2>
<ul>
<li><code>NT</code>头有三个主要结构体。其中一个是NT标识即<code>IMAGE_NT_HEADERS</code>，还有俩个子结构<code>IMAGE_FILE_HEADER</code>、<code>IMAGE_OPTIONAL_HEADER</code>。</li>
</ul>
<h3 id="nt头_nt_headers">NT头_NT_HEADERS</h3>
<ul>
<li>在<code>VS</code>中查看<code>NT</code>头，发现<code>NT</code>头定义有区分<code>32</code>位和<code>64</code>位</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701194501594.png" alt="image-20250701194501594"></p>
<ul>
<li>其结构体就是这样(以32位为例子，先介绍32位的)</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_NT_HEADERS</span> &#123;</span></span><br><span class="line">  DWORD Signature;							 <span class="comment">// NT头的标识4字节,&quot;PE\x00\x00&quot; (0x4550 小端序就是0x50 0x45 0x00 0x00)</span></span><br><span class="line">  IMAGE_FILE_HEADER FileHeader;				 <span class="comment">// NT文件头</span></span><br><span class="line">  IMAGE_OPTIONAL_HEADER32 OptionalHeader;	 <span class="comment">// NT的选项头文件,为可执行文件指定选项</span></span><br><span class="line">&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br></pre></td></tr></table></figure>
<ul>
<li>下面是<code>NT</code>文件头文件格式的<code>16</code>进制分布</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701195743221.png" alt="image-20250701195743221"></p>
<h3 id="nt的文件头_file_headers">NT的文件头_FILE_HEADERS</h3>
<ul>
<li>依然是这张图片，其中标<code>CC</code>的就是可以利用的。</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701195743221.png" alt="image-20250701195743221"></p>
<ul>
<li>直接查看<code>vs</code>的<code>IMAGE_FILE_HEADER</code>的结构体</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701200007106.png" alt="image-20250701200007106"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_FILE_HEADER</span>&#123;</span></span><br><span class="line">    WORD Machine;				<span class="comment">// 一个宏,表示该程序是什么架构的程序,包括MIPS小端序、Intel 386等不同架构的程序,之后会详细说明</span></span><br><span class="line">    WORD NumberOfSections;		<span class="comment">// 描述节区总数也就是IMAGE_SECTION_HEADER个数</span></span><br><span class="line">    DWORD TimeDateStamp;		<span class="comment">// 每个可执行文件产生的时间(可以参考,但是不可信,因为别人可以改)</span></span><br><span class="line">    DWORD PointerToSymbolTable;	<span class="comment">// 指向COFF符号表的文件偏移(距离文件开头的字节数)</span></span><br><span class="line">    DWORD NumberOfSymbols;		<span class="comment">// 符号表中包含的符号个数</span></span><br><span class="line">    WORD sizeOfOptionalHeader;	<span class="comment">// 描述后面的IMAGE_OPTIONAL_HEADER32的大小</span></span><br><span class="line">    WORD Characteristics;		<span class="comment">// 该可执行文件的属性,可以知道该程序是PE文件中的哪一种.exe、.dll、.sys</span></span><br><span class="line">&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;</span><br></pre></td></tr></table></figure>
<ul>
<li>注意如果合理修改了<code>sizeOfOptionalHeader</code>的值，其实程序是可以正常运行，但是程序可能不能进行动态调试，动态调试可能就会出现问题。</li>
</ul>
<h4 id="machin宏定义">Machin宏定义</h4>
<ul>
<li>上面<code>FILE_HEADER</code>中的<code>Machine</code>宏定义也可以在<code>VS</code>中能看到，某些宏定义可以经过<code>与</code>操作组合在一起</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701200837227.png" alt="image-20250701200837227"></p>
<ul>
<li>在上图中又几个比较重要和常见的架构宏定义</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_I386              0x014c  <span class="comment">// Intel 386架构</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_IA64              0x0200  <span class="comment">// Intel 64</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_ARM               0x01c0  <span class="comment">// ARM 小端序</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_AMD64             0x8664  <span class="comment">// AMD64 (K8)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>介绍一下这些宏定义在的架构和类型</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_RELOCS_STRIPPED           0x0001  <span class="comment">// 去掉了重定位信息（常见于绝对地址绑定的程序）</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_EXECUTABLE_IMAGE          0x0002  <span class="comment">// 可执行映像(非obj)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_LINE_NUMS_STRIPPED        0x0004  <span class="comment">// 去掉调试行号信息</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_LOCAL_SYMS_STRIPPED       0x0008  <span class="comment">// 去掉局部符号表信息</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_AGGRESIVE_WS_TRIM         0x0010  <span class="comment">// 工作集裁剪标志</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_LARGE_ADDRESS_AWARE       0x0020  <span class="comment">// 程序能访问大于2GB的地址空间(主要在x64系统上)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_BYTES_REVERSED_LO         0x0080  <span class="comment">// 用于老系统检测字节序(低位反转)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_32BIT_MACHINE             0x0100  <span class="comment">// 32位程序</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_DEBUG_STRIPPED            0x0200  <span class="comment">// 去除调试信息</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP   0x0400  <span class="comment">// 来自可移动设备时,复制到交换文件运行</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_NET_RUN_FROM_SWAP         0x0800  <span class="comment">// 来自网络运行时,复制到交换文件运行</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_SYSTEM                    0x1000  <span class="comment">// 标识该文件是系统文件(NTDLL、KERNEL32等).</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_DLL                       0x2000  <span class="comment">// 标识该文件是DLL类型的PE文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_UP_SYSTEM_ONLY            0x4000  <span class="comment">// 只能在但处理器机器上运行</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_BYTES_REVERSED_HI         0x8000  <span class="comment">// 字节高位反转,比较少见,用于字节序检测</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_UNKNOWN           0		 <span class="comment">// 表示未知架构</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_TARGET_HOST       0x0001  <span class="comment">// 用于宿主机而非虚拟化环境</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_I386              0x014c  <span class="comment">// Intel 386架构</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_R3000             0x0162  <span class="comment">// MIPS 小端序架构, 0x160为大端序架构</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_R4000             0x0166  <span class="comment">// MIPS little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_R10000            0x0168  <span class="comment">// MIPS little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_WCEMIPSV2         0x0169  <span class="comment">// MIPS little-endian WCE v2</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_ALPHA             0x0184  <span class="comment">// Alpha_AXP</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_SH3               0x01a2  <span class="comment">// SH3 little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_SH3DSP            0x01a3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_SH3E              0x01a4  <span class="comment">// SH3E 小端序</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_SH4               0x01a6  <span class="comment">// SH4 小端序</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_SH5               0x01a8  <span class="comment">// SH5</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_ARM               0x01c0  <span class="comment">// ARM 小端序</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_THUMB             0x01c2  <span class="comment">// ARM Thumb/Thumb-2 小端序</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_ARMNT             0x01c4  <span class="comment">// ARM Thumb-2 小端序</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_AM33              0x01d3	 <span class="comment">// AM33 架构</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_POWERPC           0x01F0  <span class="comment">// IBM PowerPC Little-Endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_POWERPCFP         0x01f1	 <span class="comment">// IBM PowerPC 架构</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_IA64              0x0200  <span class="comment">// Intel 64</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_MIPS16            0x0266  <span class="comment">// MIPS</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_ALPHA64           0x0284  <span class="comment">// ALPHA64</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_MIPSFPU           0x0366  <span class="comment">// MIPS</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_MIPSFPU16         0x0466  <span class="comment">// MIPS</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_AXP64             IMAGE_FILE_MACHINE_ALPHA64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_TRICORE           0x0520  <span class="comment">// Infineon</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_CEF               0x0CEF	 <span class="comment">// Infineon TriCore 架构 (混合型 RISC 架构处理器)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_EBC               0x0EBC  <span class="comment">// EFI Byte Code</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_AMD64             0x8664  <span class="comment">// AMD64 (K8)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_M32R              0x9041  <span class="comment">// M32R小端序</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_ARM64             0xAA64  <span class="comment">// ARM64小端序</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_CEE               0xC0EE	 <span class="comment">// CEE虚拟机生成的可执行文件</span></span></span><br></pre></td></tr></table></figure>
<h3 id="nt的选项头文件_optional_header">NT的选项头文件_OPTIONAL_HEADER</h3>
<ul>
<li>选项头有三类<code>32位选项头</code>、<code>64位选项头</code>、<code>嵌入式选项头</code>。这里主要介绍<code>32位选项头</code>和<code>64</code>位选项头</li>
<li>从<code>FILE_HEADERS</code>倒数第<code>3、4</code>字节就可以得到<code>optional header</code>的大小，其实就是<code>0xE0</code>，从而得到<code>optional head</code>的那一块区域</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701210423532.png" alt="image-20250701210423532"></p>
<ul>
<li>先查看一下<code>IMAGE_OPTIONAL_HEADER32</code>的结构体</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701212448754.png" alt="image-20250701212448754"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个是32位的选项头重点介绍</span></span><br><span class="line"><span class="comment">// 其实32位的结构和64位头结构一样,只是关于地址描述部分WORD、DWORD和ULONGLONG(无符号长整型)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_OPTIONAL_HEADER</span>&#123;</span></span><br><span class="line">    WORD Magic;				<span class="comment">//0x00类似于PE、MZ这样的识别,有三个宏定义.IMAGE_NT_OPTIONAL_HDR_MAGIC可执行文件,IMAGE_ROM_OPTIONAL_HDR_MAGIC在ROM的文件用作固件(一般是UEFI ROM、BIOS插件模块、或者是在嵌入式设备中的),IMAGE_NT_OPTIONAL_HDR64_MAGIC</span></span><br><span class="line">    BYTE MajorLinkerVersion; 			<span class="comment">// 链接器主版本号</span></span><br><span class="line">    BYTE MinorLinkerversion; 			<span class="comment">// 链接器次版本号</span></span><br><span class="line">    DWORD SizeOfCode;					<span class="comment">// 当前可执行文件所包含代码的总大小</span></span><br><span class="line">    DWORD SizeOfInitializedData;		<span class="comment">// 已初始化数据的总大小 .data 、.const已初始化</span></span><br><span class="line">    DWORD SizeOfUninitializedData;		<span class="comment">// 未初始化数据的总大小 .data? 未初始化 (对应已初始化的数据程序编译的时候需要记录数据内容,对于未初始化的数据不要保留位置,只需要记录SizeOfUninitializedData即可)</span></span><br><span class="line">    <span class="comment">// 上面这3个sizeOf都是说明性的东西,可以任意修改不影响执行,但是可以干扰调试调试器(可以用于反调试)</span></span><br><span class="line">    DWORD AddressOfEntryPoint;			<span class="comment">// 程序入口点地址,简称EP(当前入口点)。OEP(原始入口点),在加壳的时候这么称呼</span></span><br><span class="line">    DWORD BaseOfCode;					<span class="comment">// 代码基地址,程序偏移多少字节到代码段地址开头</span></span><br><span class="line">    DWORD BaseOfData;					<span class="comment">// 数据基地址,数据的起始地址</span></span><br><span class="line">    <span class="comment">//上面程序基地址和数据基地址都是可以被修改的,这种其实也是反调试的方法之一</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 以上这个部分是三个可选头共同的</span></span><br><span class="line">    DWORD ImageBase;					<span class="comment">// (建议装载地址)程序默认的加载地址,如0x400000,方便操作系统重定位	</span></span><br><span class="line">    DWORD SectionAlignment;				<span class="comment">// 映像(内存中)每个节(Section)的对齐大小,通常为0x1000 </span></span><br><span class="line">    DWORD FileAlignment;				<span class="comment">// 文件中每个节的对齐大小,通常为0x200,不满足0x200大小的就会补0</span></span><br><span class="line">    WORD MajorOperatingSystemVersion;	<span class="comment">// 要求的最低操作系统主版本</span></span><br><span class="line">    WORD MinorOperatingSystemVersion;	<span class="comment">// 要求的最低操作系统次版本</span></span><br><span class="line">    WORD MajorImageVersion;				<span class="comment">// 应用程序自身主版本号(开发者填写)</span></span><br><span class="line">    WORD MinorImageVersion;				<span class="comment">// 应用程序自身次版本号</span></span><br><span class="line">    WORD MajorSubsystemVersion;			<span class="comment">// 所需子系统主版本</span></span><br><span class="line">    WORD MinorSubsystemVersion;			<span class="comment">// 所需子系统次版本</span></span><br><span class="line">    DWORD Win32VersionValue;			<span class="comment">// 通常为0,保留字段</span></span><br><span class="line">    DWORD SizeOfImage;					<span class="comment">// 映像整体大小(对齐到SectionAlignment),用于加载时分配内存,必须对齐于SectionAlignment中的数据</span></span><br><span class="line">    DWORD SizeOfHeaders;				<span class="comment">// 所有头部大小之和(DOS头+PE头+节表+可选头)</span></span><br><span class="line">    DWORD CheckSum;						<span class="comment">// 可执行文件的校验和,用户程序一般不用检查校验和,如果是系统文件驱动等就需要检查校验和,判断其是否被修改或者出错误(3环的时候能利用,0环不能)</span></span><br><span class="line">    WORD Subsystem;						<span class="comment">// 表示运行环境,GUI、Console、Native</span></span><br><span class="line">    WORD DllCharacteristics;			<span class="comment">// DLL特性标志,例如ASLR、DEP支持等,如0x40动态重定位、NX兼容等</span></span><br><span class="line">    DWORD SizeOfStackReserve;			<span class="comment">// 初始保留的栈空间大小</span></span><br><span class="line">    DWORD SizeOfStackCommit;			<span class="comment">// 初始提交(分配)的栈空间</span></span><br><span class="line">    DWORD SizeOfHeapReserve;			<span class="comment">// 初始保留的堆大小</span></span><br><span class="line">    DWORD SizeOfHeapCommit;				<span class="comment">// 初始提交的堆大小</span></span><br><span class="line">    DWORD LoaderFlags;					<span class="comment">// 保留字段,一般为0,可以自己写个值,在程序运行的时候读这个值</span></span><br><span class="line">    DWORD NumberOfRvaAndSizes;			<span class="comment">// DataDirectory中有效条目数量(通常为16)</span></span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES]; <span class="comment">//一个数组,每项是一个数据目录项,包括导入表、导出表、资源表、异常表</span></span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br><span class="line"><span class="comment">// DataDirectory[0]位导出函数表DLL,DataDirectory[1]位导入函数表,DataDirectory[2]位资源</span></span><br><span class="line"><span class="comment">// DataDirectory[3]异常处理信息</span></span><br></pre></td></tr></table></figure>
<ul>
<li>对于<code>DWORD FileAlignment;</code>这个文件对齐，紫色框部分才是代码的部分，但是由于文件需要<code>0x200</code>字节对齐，所以剩余部分需要补充<code>\x00</code></li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250702012000846.png" alt="image-20250702012000846"></p>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250702200111516.png" alt="image-20250702200111516"></p>
<h4 id="sizeofheaders">SizeOfHeaders</h4>
<ul>
<li><code>SizeOfHeaders</code>指的是可执行文件的头部大小，从<code>SizeOfHeaders</code>中可以看出来<code>PE文件头大小为0x400</code>，这个<code>0x400</code>需要与<code>File_aligment</code>这里面的数据对齐(也就是需要满足0x200的整数倍)，由于我们的<code>Headers</code>大于<code>0x200</code>所以需要对齐到<code>0x400</code>也就是<code>Headers</code>头结束后，填充<code>\x00</code><strong>当做无效数据</strong></li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250702200521803.png" alt="image-20250702200521803"></p>
<h4 id="subsystem">Subsystem</h4>
<ul>
<li>主要介绍一下<code>Subsystem</code>中一些宏，这个字段可以改，但是需要合理的改。</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250702201441763.png" alt="image-20250702201441763"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_UNKNOWN              0   <span class="comment">// Unknown subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_NATIVE               1   <span class="comment">// Image doesn&#x27;t require a subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_WINDOWS_GUI          2   <span class="comment">// 主要接触：Windows图形用户界面.Image runs in the Windows GUI subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_WINDOWS_CUI          3   <span class="comment">// 主要接触：Windows控制台界面.Image runs in the Windows character subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_OS2_CUI              5   <span class="comment">// image runs in the OS/2 character subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_POSIX_CUI            7   <span class="comment">// image runs in the Posix character subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_NATIVE_WINDOWS       8   <span class="comment">// 主要接触：Windows内核驱动 image is a native Win9x driver.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_WINDOWS_CE_GUI       9   <span class="comment">// Image runs in the Windows CE subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_EFI_APPLICATION      10  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_EFI_BOOT_SERVICE_DRIVER  11   <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_EFI_RUNTIME_DRIVER   12  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_EFI_ROM              13</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_XBOX                 14</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_WINDOWS_BOOT_APPLICATION 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_XBOX_CODE_CATALOG    17</span></span><br></pre></td></tr></table></figure>
<h4 id="dllcharacteristics">DllCharacteristics</h4>
<ul>
<li>关于<code>Dll</code>的属性描述</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0001</span> 	保留字段</span><br><span class="line"><span class="number">0x0002</span>	保留字段</span><br><span class="line"><span class="number">0x0004</span>	保留字段</span><br><span class="line"><span class="number">0x0008</span>	保留字段</span><br><span class="line"><span class="number">0x2000</span>	A WDM driver 基于WDM的一个驱动程序</span><br></pre></td></tr></table></figure>
<h4 id="堆栈保留和提交">堆栈保留和提交</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DWORD SizeOfStackReserve;			<span class="comment">// 初始保留的栈空间大小,程序能向操作系统申请的最大栈内存</span></span><br><span class="line">DWORD SizeOfStackCommit;			<span class="comment">// 初始提交(分配)的栈空间,程序一开始运行时需要先申请的栈大小</span></span><br><span class="line">DWORD SizeOfHeapReserve;			<span class="comment">// 初始保留的堆大小,程序能向操作系统申请的最大堆内存</span></span><br><span class="line">DWORD SizeOfHeapCommit;				<span class="comment">// 初始提交的堆大小,程序一开始运行时需要先申请的堆大小</span></span><br><span class="line"><span class="comment">// 该字段可以修改,但是需要合理修改。保留需要大于提交的大小,保留需要不超过OS的内存限制</span></span><br></pre></td></tr></table></figure>
<h3 id="image_data_directory">IMAGE_DATA_DIRECTORY</h3>
<ul>
<li><strong>数据目录</strong>是<code>PE</code>文件中的一个重要结构</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IMAGE_DATA_DIRECTORY的结构如下</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DATA_DIRECTORY</span> &#123;</span></span><br><span class="line">    DWORD   VirtualAddress;				<span class="comment">// 表的虚拟地址</span></span><br><span class="line">    DWORD   Size;						<span class="comment">// 表的大小</span></span><br><span class="line">&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;</span><br></pre></td></tr></table></figure>
<ul>
<li>数据目录数组对应的索引已经规定好了具体的数据表，下面就是具体数据表的宏定义</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_EXPORT          0   <span class="comment">// 重点:导出表Export Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_IMPORT          1   <span class="comment">// 重点:导入表Import Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_RESOURCE        2   <span class="comment">// 重点:资源描述Resource Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_EXCEPTION       3   <span class="comment">// Exception Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_SECURITY        4   <span class="comment">// Security Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_BASERELOC       5   <span class="comment">// 重点:重定位表Base Relocation Table</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_DEBUG           6   <span class="comment">// Debug Directory</span></span></span><br><span class="line"><span class="comment">//      IMAGE_DIRECTORY_ENTRY_COPYRIGHT       7   // (X86 usage)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_ARCHITECTURE    7   <span class="comment">// Architecture Specific Data</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_GLOBALPTR       8   <span class="comment">// RVA of GP</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_TLS             9   <span class="comment">// 重点:TLS Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG    10   <span class="comment">// 过时了:Load Configuration Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT   11   <span class="comment">// 过时了:Bound Import Directory in headers</span></span></span><br><span class="line"><span class="comment">// 早期Window是为了装载常用API,就将API地址固定了,但是由于OS更新比较快,每次更新地址会变,就出现问题,所以之后该文件就废弃了</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_IAT            12   <span class="comment">// 重点:IAT表 Import Address Table</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT   13   <span class="comment">// Delay Load Import Descriptors</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR 14   <span class="comment">// COM Runtime descriptor</span></span></span><br></pre></td></tr></table></figure>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250703183738734.png" alt="image-20250703183738734"></p>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250703183922862.png" alt="image-20250703183922862"></p>
<h4 id="导入表image_directory_entry_import">导入表(IMAGE_DIRECTORY_ENTRY_IMPORT)</h4>
<ul>
<li>
<p>最复杂的一个数据目录。</p>
</li>
<li>
<p>导入表的作用如下：</p>
<ul>
<li>当程序运行的时候，有时需要调用外部接口，尤其是<code>操作系统API</code>。有点类似于<code>ELF</code>文件中的<code>got表</code>。</li>
<li>当操作系统装载我们的可执行文件时，操作系统首先会分析可执行文件需要哪些库。接着分析需要这些库的哪些函数，将需要调用的函数地址，填入到操作系统和编译器约定好的位置。</li>
<li>编译器在编译好代码的时候，运行该程序，该程序在调用操作系统的相关<code>API</code>的时候就会到约定好的地址对这个<code>API</code>进行间接的反问。</li>
<li>而操作系统与应用程序约定好填入<code>API</code>的位置被称为<strong>Import Address Table简称IAT</strong>，调用<code>API</code>的地址是不固定的。</li>
</ul>
</li>
<li>
<p>导入表需要记录俩个东西<code>函数对应的动态库</code>、<code>动态库中的具体函数</code>（这两者的关系就相当于学生和班级这一数据关系，<code>一个动态库对应多个班级</code>）</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">IMAGE_DIRECTORY_ENTRY_IMPORT;	 	<span class="comment">//导入表</span></span><br><span class="line">	IMAGE_IMPORY_DESCRIPTOR; 	 	<span class="comment">//导入表子结构</span></span><br><span class="line">		IMAGE_THUNK_DATA;   	 	<span class="comment">//导入表子结构</span></span><br><span class="line">			IMAGE_IMPORT_BY_NAME; 	<span class="comment">// 导入表子结构</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入表中其实最先是IMAGE_IMPORY_DESCRIPTOR这个结构</span></span><br><span class="line"><span class="comment">// 存放动态库的信息,也就相当于学生与班级这一数据关系中的班级信息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_IMPORT_DESCRIPTOR</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD   Characteristics;            <span class="comment">// 0 for terminating null import descriptor</span></span><br><span class="line">        DWORD   OriginalFirstThunk;         <span class="comment">// 不太重要RVA to original unbound IAT (PIMAGE_THUNK_DATA)</span></span><br><span class="line">    &#125; DUMMYUNIONNAME;</span><br><span class="line">    DWORD   TimeDateStamp;                  <span class="comment">// 不太重要0 if not bound,</span></span><br><span class="line">                                            <span class="comment">// 不太重要-1 if bound, and real date\time stamp</span></span><br><span class="line">                                            <span class="comment">// 不太重要in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)</span></span><br><span class="line">                                            <span class="comment">// 不太重要O.W. date/time stamp of DLL bound to (Old BIND)</span></span><br><span class="line"></span><br><span class="line">    DWORD   ForwarderChain;                 <span class="comment">// 不太重要-1 if no forwarders</span></span><br><span class="line">    DWORD   Name;							<span class="comment">// 重要:动态库的名称</span></span><br><span class="line">    DWORD   FirstThunk;                     <span class="comment">// 重要:存放地址 RVA to IAT (if bound this IAT has actual addresses)</span></span><br><span class="line">&#125; IMAGE_IMPORT_DESCRIPTOR;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR;</span><br></pre></td></tr></table></figure>
<ul>
<li>在编译时，操作系统装载库函数的过程：
<ul>
<li>首先遍历动态库信息，获得目标的库函数信息</li>
<li>然后读取函数信息表，将目标函数填入对应<code>IAT</code>结构体的中</li>
</ul>
</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250703212813870.png" alt="image-20250703212813870"></p>
<ul>
<li>使用<code>xdbg</code>查看内存</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250703213544177.png" alt="image-20250703213544177"></p>
<ul>
<li>通过<code>表的内存偏移</code>找到真实导入表</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250703214019750.png" alt="image-20250703214019750"></p>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250703214044597.png" alt="image-20250703214044597"></p>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250703214109670.png" alt="image-20250703214109670"></p>
<ul>
<li>以下面张图片来将一下具体的过程：
<ul>
<li>首先遍历第一个动态库的信息，先会找到库名称(图中阴影部分第一行最后<code>3A 22 00 00 </code>就是存储库函数名称的地址)</li>
<li>接着操作系统就会<code>载入相应的库</code>，如果载入失败，就会弹出缺少<code>.dll</code>依赖</li>
</ul>
</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250703221053131.png" alt="image-20250703221053131"></p>
<ul>
<li>接着会根据<code>24 22 00 00</code>找到<code>对应偏移为24 22 00 00</code>的这个地方其实是一个数组，存放着被引用函数的信息，但是这里由于我们只使用了<code>第一个库中的第一个函数</code>，所以这里的数组长度就为1。</li>
<li>如果多个的话，就会有很多项直到<code>00 00 00 00 </code>结尾，之后<code>2c 22 00 00 </code>就会定位到<code>_IMAGE_IMPORT_BY_NAME</code>结构体</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250703220526477.png" alt="image-20250703220526477"></p>
<ul>
<li>之后就是这样的一个数据，该数据其实就是如下结构体
<ul>
<li><code>WORD Hint</code>不是很重要，仅供参考</li>
<li><code>CHAR Name[1]</code>其实是一个可变长数组，存放的是函数的名称</li>
<li>这样我们就拿到了函数名称，拿到函数名就可以得到函数对应的地址，得到函数对应地址后</li>
</ul>
</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250703215556833.png" alt="image-20250703215556833"></p>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250703215953330.png" alt="image-20250703215953330"></p>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250703220229783.png" alt="image-20250703220229783"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_IMPORT_BY_NAME</span> &#123;</span></span><br><span class="line">    WORD    Hint;</span><br><span class="line">    CHAR   Name[<span class="number">1</span>];</span><br><span class="line">&#125; IMAGE_IMPORT_BY_NAME, *PIMAGE_IMPORT_BY_NAME;</span><br></pre></td></tr></table></figure>
<h4 id="导出表image_directoryt_entry_export">导出表(IMAGE_DIRECTORYT_ENTRY_EXPORT)</h4>
<h4 id="导入地址表import-address-table">导入地址表(Import Address Table)</h4>
<h3 id="nt_optional_hdr64">NT_OPTIONAL_HDR64</h3>
<h3 id="rom_optional_hdr">ROM_OPTIONAL_HDR</h3>
<h2 id="段头">段头</h2>
<ul>
<li><code>PE</code>文件头的这个位置其实就是段头的位置，先来看一下每个段头的结构</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250702204723216.png" alt="image-20250702204723216"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果要确定段头,需要先找数据目录</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_SECTION_HEADER</span> &#123;</span></span><br><span class="line">	BYTE Name[IMAGE_SIZEOF_SHORT_NAME]; <span class="comment">// 0x00段名如:.text 、.rdata、.data、.rsrc、.reloc,类似于注释,描述该节是做什么的(段名称可以重复,也可以乱写)</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">			DWORD PhysicalAddress;		<span class="comment">// 仅用于某些平台，现在常使用 VirtualSize</span></span><br><span class="line">			DWORD VirtualSize;			<span class="comment">// 0x08 节的实际大小(而不是节头的大小)</span></span><br><span class="line">	 &#125; Misc;							</span><br><span class="line">	DWORD VirtualAddress;				<span class="comment">// 0xC 	相对虚拟地址</span></span><br><span class="line">	DWORD SizeOfRawData;				<span class="comment">// 0x10 需要载入内存的数据总大小,文件描述与NT可选头中FileAlignment对应</span></span><br><span class="line">	DWORD PointerToRawData;				<span class="comment">// 0x14 节数据在文件中的偏移地址 </span></span><br><span class="line">	DWORD PointerToRelocations;			<span class="comment">// 0x18 重定位的信息 (为兼容其他系统所做)</span></span><br><span class="line">	DWORD PointerToLinenumber;			<span class="comment">// 0x1c 行信息	(为兼容其他系统所做)</span></span><br><span class="line">	WORD NumberOfRelocations;			<span class="comment">// 0x20 重定位总数	(为兼容其他系统所做)</span></span><br><span class="line">	WORD NumberOfLinenumbers;			<span class="comment">// 0x24 行总数	(为兼容其他系统所做)</span></span><br><span class="line">	DWORD Characteristics;				<span class="comment">// 0x28 内存属性,可读、可写、可执行、可共享是位描述W、R、E、S</span></span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>.text</code>段来分析一下这个结构体，结合着下面内存映射的来解读一下<code>.text</code>段载入内存
<ul>
<li>首先是名为<code>.text</code>段的一个段，会从文件偏移<code>0x400</code>的位置将数据载入到内存<code>相对地址为0x1000</code>的位置，载入实际有效的数据为<code>0x27</code>个字节(实际上载入总数是0x200字节即<code>SizeOfRawData</code>的大小)</li>
<li>并且内存要满足与<code>NT可选头中的SectionAlignment对齐</code></li>
<li>而<code>VirtualSize</code>这里面的数据是半说明性质的（可以适当修改）</li>
<li>然后给该内存段<code>可执行、可读</code>的权限</li>
</ul>
</li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250702205544398.png" alt="image-20250702205544398"></p>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250702212827539.png" alt="image-20250702212827539"></p>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250702210926335.png" alt="image-20250702210926335"></p>
<h3 id="virtualaddress">VirtualAddress</h3>
<ul>
<li>存储着是文件中的<code>各个Section段</code>载入到内存后的起始偏移地址。所以在内存中的地址应该是这样计算。并且文件载入到内存中每一段的大小需要与<strong>NT可选头的</strong><code>SectionAlignment</code>里面的值对齐</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">绝对地址 = VirtualAddress + Image_Base(但是Image_Base不可信这里需要注意)</span><br></pre></td></tr></table></figure>
<h3 id="characteristics">Characteristics</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">R 可读   </span><br><span class="line">W 可写 </span><br><span class="line">E 可执行</span><br><span class="line">S 可共享</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_DISCARDABLE            0x02000000  <span class="comment">// Section can be discarded.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_NOT_CACHED             0x04000000  <span class="comment">// Section is not cachable.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_NOT_PAGED              0x08000000  <span class="comment">// Section is not pageable.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_SHARED                 0x10000000  <span class="comment">// Section is shareable.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_EXECUTE                0x20000000  <span class="comment">// Section is executable.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_READ                   0x40000000  <span class="comment">// Section is readable.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_WRITE                  0x80000000  <span class="comment">// Section is writeable.</span></span></span><br><span class="line"><span class="comment">// 可读可写可执行不可共享其实就是将这些位坐或运算 0x20000000 | 0x40000000 | 0x80000000</span></span><br><span class="line"><span class="comment">// Characteristics字段可以改，但是需要适当的改</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">//下面的是 Characteristic的其他宏定义,了解即可</span></span><br><span class="line"><span class="comment">// Section characteristics.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_TYPE_REG                   0x00000000  // Reserved.</span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_TYPE_DSECT                 0x00000001  // Reserved.</span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_TYPE_NOLOAD                0x00000002  // Reserved.</span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_TYPE_GROUP                 0x00000004  // Reserved.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_TYPE_NO_PAD                0x00000008  <span class="comment">// Reserved.</span></span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_TYPE_COPY                  0x00000010  // Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_CNT_CODE                   0x00000020  <span class="comment">// Section contains code.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_CNT_INITIALIZED_DATA       0x00000040  <span class="comment">// Section contains initialized data.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_CNT_UNINITIALIZED_DATA     0x00000080  <span class="comment">// Section contains uninitialized data.</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_LNK_OTHER                  0x00000100  <span class="comment">// Reserved.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_LNK_INFO                   0x00000200  <span class="comment">// Section contains comments or some other type of information.</span></span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_TYPE_OVER                  0x00000400  // Reserved.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_LNK_REMOVE                 0x00000800  <span class="comment">// Section contents will not become part of image.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_LNK_COMDAT                 0x00001000  <span class="comment">// Section contents comdat.</span></span></span><br><span class="line"><span class="comment">//                                           0x00002000  // Reserved.</span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_MEM_PROTECTED - Obsolete   0x00004000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_NO_DEFER_SPEC_EXC          0x00004000  <span class="comment">// Reset speculative exceptions handling bits in the TLB entries for this section.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_GPREL                      0x00008000  <span class="comment">// Section content can be accessed relative to GP</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_FARDATA                0x00008000</span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_MEM_SYSHEAP  - Obsolete    0x00010000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_PURGEABLE              0x00020000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_16BIT                  0x00020000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_LOCKED                 0x00040000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_PRELOAD                0x00080000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_1BYTES               0x00100000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_2BYTES               0x00200000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_4BYTES               0x00300000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_8BYTES               0x00400000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_16BYTES              0x00500000  <span class="comment">// Default alignment if no others are specified.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_32BYTES              0x00600000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_64BYTES              0x00700000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_128BYTES             0x00800000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_256BYTES             0x00900000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_512BYTES             0x00A00000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_1024BYTES            0x00B00000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_2048BYTES            0x00C00000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_4096BYTES            0x00D00000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_8192BYTES            0x00E00000  <span class="comment">//</span></span></span><br><span class="line"><span class="comment">// Unused                                    0x00F00000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_MASK                 0x00F00000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_LNK_NRELOC_OVFL            0x01000000  <span class="comment">// Section contains extended relocations.</span></span></span><br></pre></td></tr></table></figure>
<h2 id="无效数据">无效数据</h2>
<ul>
<li>无效数据是为了对齐，所以在<code>PE</code>文件头写完了<code>DOS头</code>、<code>NT头</code>和<code>段头</code>之后如果程序偏移还没有到<code>0x400</code>，此时就需要使用无效数据<code>\x00</code>进行偏移操作。</li>
<li>之后从<code>0x400</code>开始其实就是存放着<code>段数据</code></li>
</ul>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701210829931.png" alt="image-20250701210829931"></p>
<h2 id="段数据">段数据</h2>
<h2 id="附加数据">附加数据</h2>
<h2 id="vs2022查看pe结构体">VS2022查看PE结构体</h2>
<ul>
<li>新建一个项目，编写如下代码，鼠标选中<code>IMAGE_DOS_HEADER</code>就可以跳转到对应结构体的定义中。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">IMAGE_DOS_HEADER;</span><br></pre></td></tr></table></figure>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701183153887.png" alt="image-20250701183153887"></p>
<p><img src="/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20250701183329984.png" alt="image-20250701183329984"></p>
<h1 id="地址转换">地址转换</h1>
<h1 id="玩转导入表">玩转导入表</h1>
<h1 id="进阶">进阶</h1>
<ol>
<li>尝试自己编写一个小程序，试着修改一些无关值，查看程序能不能正常执行。</li>
<li>尝试编写一个像<code>CFF</code>这样的界面，可以读取查看<code>PE</code>文件头结构，还可以<code>修改</code>。</li>
<li>尝试修改<code>DOS</code>那边的<code>stub</code>部分，使得某个简单的程序能在<code>DOS</code>环境下也能实现功能。</li>
<li>尝试添加一个节头，该节用于注入操作(添加节头即可，注入的代码后面再说)<strong>三步走</strong>
<ul>
<li>第一步添加新节描述</li>
<li>第二步添加新节数据</li>
<li>修改NT可选头中的<code>SizeOfImage</code>、修改节表总数即修改NT头中的<code>NumberOfSections</code>的个数</li>
</ul>
</li>
<li>添加一个没有文件映射的节头即未初始化数据，对应高级语言中的未初始化的全局变量，以及汇编中的<code>.data?</code></li>
<li>添加一个变形的未初始化区，即在文件中的数据<code>小于等于0x200</code>，但是映射到内存映射<code>0x2000</code>字节大小</li>
<li>写一个类似<code>CFF</code>中能自动计算文件偏移，并且可以自动定位数据的程序，可以作为<code>2.</code>程序中的功能</li>
<li>尝试修改导入表，进行<code>.dll</code>hook操作</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://iyheart.github.io">iyheart</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://iyheart.github.io/2025/08/08/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/">http://iyheart.github.io/2025/08/08/CTFblog/REVERSE系列blog/Windows逆向/PE文件结构/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://iyheart.github.io" target="_blank">iyheart的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/cover201.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/ea2e5fb6fbb4c236fbabd387ef83339.jpg" target="_blank"><img class="post-qr-code-img" src="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/ea2e5fb6fbb4c236fbabd387ef83339.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/08/08/CTFblog/CRYPTO%E7%B3%BB%E5%88%97blog/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86/RSA/RSA%E5%8A%A0%E5%AF%86%E4%B9%8Be%E5%92%8Cphi%E4%B8%8D%E4%BA%92%E7%B4%A0/" title="RSA加密之e和phi不互素"><img class="cover" src="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/cover202.png" onerror="onerror=null;src='https://raw.githubusercontent.com/iyheart/tuchuang/main/img/f3c2605738aabdeedbc687356fa0e4e5.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">RSA加密之e和phi不互素</div></div></a></div><div class="next-post pull-right"><a href="/2025/08/05/%E6%95%B0%E5%AD%A6blog/%E5%88%9D%E7%AD%89%E6%95%B0%E8%AE%BA/%E6%95%B0%E8%AE%BA%E5%9F%BA%E7%A1%80-%E5%8E%9F%E6%A0%B9%E4%B8%8E%E6%8C%87%E6%A0%87/" title="数论基础-原根与指标"><img class="cover" src="https://raw.githubusercontent.com/iyheart/tuchuang/main/img/cover199.png" onerror="onerror=null;src='https://raw.githubusercontent.com/iyheart/tuchuang/main/img/f3c2605738aabdeedbc687356fa0e4e5.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">数论基础-原根与指标</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="http://pic.5tu.cn/uploads/allimg/1910/pic_5tu_big_2019010211653346247.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">iyheart</div><div class="author-info__description">悟已往之不谏，知来者之可追</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">163</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">49</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#vs2022%E5%86%99%E6%B1%87%E7%BC%96"><span class="toc-number">1.</span> <span class="toc-text">VS2022写汇编</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E7%AE%80%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">PE文件结构简述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">PE文件结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dos%E5%A4%B4"><span class="toc-number">3.1.</span> <span class="toc-text">DOS头</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nt%E5%A4%B4"><span class="toc-number">3.2.</span> <span class="toc-text">NT头</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nt%E5%A4%B4_nt_headers"><span class="toc-number">3.2.1.</span> <span class="toc-text">NT头_NT_HEADERS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nt%E7%9A%84%E6%96%87%E4%BB%B6%E5%A4%B4_file_headers"><span class="toc-number">3.2.2.</span> <span class="toc-text">NT的文件头_FILE_HEADERS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#machin%E5%AE%8F%E5%AE%9A%E4%B9%89"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">Machin宏定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nt%E7%9A%84%E9%80%89%E9%A1%B9%E5%A4%B4%E6%96%87%E4%BB%B6_optional_header"><span class="toc-number">3.2.3.</span> <span class="toc-text">NT的选项头文件_OPTIONAL_HEADER</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sizeofheaders"><span class="toc-number">3.2.3.1.</span> <span class="toc-text">SizeOfHeaders</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#subsystem"><span class="toc-number">3.2.3.2.</span> <span class="toc-text">Subsystem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dllcharacteristics"><span class="toc-number">3.2.3.3.</span> <span class="toc-text">DllCharacteristics</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A0%86%E6%A0%88%E4%BF%9D%E7%95%99%E5%92%8C%E6%8F%90%E4%BA%A4"><span class="toc-number">3.2.3.4.</span> <span class="toc-text">堆栈保留和提交</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#image_data_directory"><span class="toc-number">3.2.4.</span> <span class="toc-text">IMAGE_DATA_DIRECTORY</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E8%A1%A8image_directory_entry_import"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">导入表(IMAGE_DIRECTORY_ENTRY_IMPORT)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%87%BA%E8%A1%A8image_directoryt_entry_export"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">导出表(IMAGE_DIRECTORYT_ENTRY_EXPORT)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%9C%B0%E5%9D%80%E8%A1%A8import-address-table"><span class="toc-number">3.2.4.3.</span> <span class="toc-text">导入地址表(Import Address Table)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nt_optional_hdr64"><span class="toc-number">3.2.5.</span> <span class="toc-text">NT_OPTIONAL_HDR64</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rom_optional_hdr"><span class="toc-number">3.2.6.</span> <span class="toc-text">ROM_OPTIONAL_HDR</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AE%B5%E5%A4%B4"><span class="toc-number">3.3.</span> <span class="toc-text">段头</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#virtualaddress"><span class="toc-number">3.3.1.</span> <span class="toc-text">VirtualAddress</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#characteristics"><span class="toc-number">3.3.2.</span> <span class="toc-text">Characteristics</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E6%95%88%E6%95%B0%E6%8D%AE"><span class="toc-number">3.4.</span> <span class="toc-text">无效数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AE%B5%E6%95%B0%E6%8D%AE"><span class="toc-number">3.5.</span> <span class="toc-text">段数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%8A%A0%E6%95%B0%E6%8D%AE"><span class="toc-number">3.6.</span> <span class="toc-text">附加数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vs2022%E6%9F%A5%E7%9C%8Bpe%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">3.7.</span> <span class="toc-text">VS2022查看PE结构体</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2"><span class="toc-number">4.</span> <span class="toc-text">地址转换</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%A9%E8%BD%AC%E5%AF%BC%E5%85%A5%E8%A1%A8"><span class="toc-number">5.</span> <span class="toc-text">玩转导入表</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6"><span class="toc-number">6.</span> <span class="toc-text">进阶</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/31/CTFblog/CRYPTO%E7%B3%BB%E5%88%97blog/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/%E4%B8%80%E6%AC%A1%E6%80%A7%E7%AD%BE%E5%90%8D-WOTS/" title="一次性签名-WOTS">一次性签名-WOTS</a><time datetime="2025-08-31T08:06:07.000Z" title="发表于 2025-08-31 16:06:07">2025-08-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/26/%E6%95%B0%E5%AD%A6blog/%E9%AB%98%E7%AD%89%E4%BB%A3%E6%95%B0/%E9%AB%98%E7%AD%89%E4%BB%A3%E6%95%B0-%E7%BA%BF%E6%80%A7%E6%96%B9%E7%A8%8B%E7%BB%84/" title="高等代数-线性方程组">高等代数-线性方程组</a><time datetime="2025-08-26T09:00:37.000Z" title="发表于 2025-08-26 17:00:37">2025-08-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/21/%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95%E6%95%B0%E8%AE%BA/%E7%AE%97%E6%B3%95%E6%95%B0%E8%AE%BA-%E7%B4%A0%E6%80%A7%E6%A3%80%E9%AA%8C%E7%AE%97%E6%B3%95/" title="算法数论-素性检验算法">算法数论-素性检验算法</a><time datetime="2025-08-21T12:23:16.000Z" title="发表于 2025-08-21 20:23:16">2025-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/13/CTFblog/CRYPTO%E7%B3%BB%E5%88%97blog/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86/Elliptic_Curve/ECDSA-Attack/" title="椭圆曲线数字签名相关攻击">椭圆曲线数字签名相关攻击</a><time datetime="2025-08-12T16:37:23.000Z" title="发表于 2025-08-13 00:37:23">2025-08-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/10/CTFblog/REVERSE%E7%B3%BB%E5%88%97blog/Windows%E9%80%86%E5%90%91/PE%E9%80%86%E5%90%91%E5%AE%9A%E4%BD%8Dmain%E5%87%BD%E6%95%B0/" title="PE逆向定位main函数">PE逆向定位main函数</a><time datetime="2025-08-10T15:37:33.000Z" title="发表于 2025-08-10 23:37:33">2025-08-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By iyheart</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script src="/zhheo/random.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>